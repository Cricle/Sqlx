// -----------------------------------------------------------------------
// <auto-generated>
// -----------------------------------------------------------------------

namespace Sqlx;

using System.Collections.Generic;
using System.Linq;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;

public partial class CSharpGenerator
{
    /// <summary>
    /// C# specific syntax receiver for collecting method symbols and repository classes.
    /// </summary>
    private class CSharpSyntaxReceiver : ISqlxSyntaxReceiver, ISyntaxReceiver
    {
        public List<IMethodSymbol> Methods { get; } = new List<IMethodSymbol>();
        public List<INamedTypeSymbol> RepositoryClasses { get; } = new List<INamedTypeSymbol>();
        
        // Collect syntax nodes for later processing
        public List<MethodDeclarationSyntax> MethodSyntaxNodes { get; } = new List<MethodDeclarationSyntax>();
        public List<ClassDeclarationSyntax> ClassSyntaxNodes { get; } = new List<ClassDeclarationSyntax>();

        public void OnVisitSyntaxNode(SyntaxNode syntaxNode)
        {
#if DEBUG
            if (syntaxNode is ClassDeclarationSyntax cls)
            {
                System.Console.WriteLine($"🔍 [ISyntaxReceiver] Found class: {cls.Identifier.Text}");
            }
#endif
            // Collect method declarations with potential Sqlx attributes
            if (syntaxNode is MethodDeclarationSyntax methodDeclaration)
            {
                if (HasSqlxAttributeSyntax(methodDeclaration))
                {
#if DEBUG
                    System.Console.WriteLine($"✅ [ISyntaxReceiver] Found Sqlx method: {methodDeclaration.Identifier.Text}");
#endif
                    MethodSyntaxNodes.Add(methodDeclaration);
                }
            }

            // Collect class declarations with potential RepositoryFor attributes
            if (syntaxNode is ClassDeclarationSyntax classDeclaration)
            {
                if (HasRepositoryForAttributeSyntax(classDeclaration))
                {
#if DEBUG
                    System.Console.WriteLine($"✅ [ISyntaxReceiver] Found RepositoryFor class: {classDeclaration.Identifier.Text}");
#endif
                    ClassSyntaxNodes.Add(classDeclaration);
                }
            }
        }

        public void OnVisitSyntaxNode(GeneratorSyntaxContext context)
        {
            // Collect methods with Sqlx attributes
            if (context.Node is MethodDeclarationSyntax methodDeclaration)
            {
                if (context.SemanticModel.GetDeclaredSymbol(methodDeclaration) is IMethodSymbol method)
                {
                    if (HasSqlxAttribute(method))
                    {
#if DEBUG
                        System.Diagnostics.Debug.WriteLine($"✅ Found Sqlx method: {method.Name} in {method.ContainingType.Name}");
#endif
                        Methods.Add(method);
                    }
                }
            }

            // Collect repository classes
            if (context.Node is ClassDeclarationSyntax classDeclaration)
            {
#if DEBUG
                System.Console.WriteLine($"🔍 Examining class: {classDeclaration.Identifier.Text}");
                System.Diagnostics.Debug.WriteLine($"🔍 Examining class: {classDeclaration.Identifier.Text}");
#endif
                if (context.SemanticModel.GetDeclaredSymbol(classDeclaration) is INamedTypeSymbol type)
                {
#if DEBUG
                    System.Diagnostics.Debug.WriteLine($"📋 Type symbol found for: {type.Name}");
#endif
                    if (HasRepositoryForAttribute(type))
                    {
#if DEBUG
                        System.Diagnostics.Debug.WriteLine($"✅ Found RepositoryFor class: {type.Name}");
#endif
                        RepositoryClasses.Add(type);
                    }
#if DEBUG
                    else
                    {
                        System.Diagnostics.Debug.WriteLine($"❌ Class {type.Name} does not have RepositoryFor attribute");
                    }
#endif
                }
#if DEBUG
                else
                {
                    System.Diagnostics.Debug.WriteLine($"❌ No type symbol found for class: {classDeclaration.Identifier.Text}");
                }
#endif
            }
        }

        private static bool HasSqlxAttribute(IMethodSymbol method)
        {
            // Only collect methods declared in classes to avoid generating implementations for interfaces
            if (method.ContainingType == null || method.ContainingType.TypeKind != TypeKind.Class)
            {
                return false;
            }

            // Prefer semantic attribute check when available
            if (method.GetAttributes().Any(attr =>
                attr.AttributeClass?.Name == "SqlxAttribute" ||
                attr.AttributeClass?.Name == "Sqlx" ||
                // RawSqlAttribute merged into SqlxAttribute
                attr.AttributeClass?.Name == "SqlExecuteTypeAttribute" ||
                attr.AttributeClass?.Name == "SqlExecuteType"))
            {
                return true;
            }

            // Fallback: syntax-based detection so tests without using directives still work
            var syntax = method.DeclaringSyntaxReferences.FirstOrDefault()?.GetSyntax() as Microsoft.CodeAnalysis.CSharp.Syntax.MethodDeclarationSyntax;
            if (syntax != null)
            {
                foreach (var attrList in syntax.AttributeLists)
                {
                    foreach (var attr in attrList.Attributes)
                    {
                        var nameText = attr.Name.ToString();
                        if (nameText is "Sqlx" or "SqlxAttribute" or "SqlExecuteType" or "SqlExecuteTypeAttribute")
                        {
                            return true;
                        }
                    }
                }
            }

            return false;
        }

        private static bool HasSqlxAttributeSyntax(MethodDeclarationSyntax methodDeclaration)
        {
            foreach (var attrList in methodDeclaration.AttributeLists)
            {
                foreach (var attr in attrList.Attributes)
                {
                    var nameText = attr.Name.ToString();
                    if (nameText is "Sqlx" or "SqlxAttribute" or "SqlExecuteType" or "SqlExecuteTypeAttribute")
                    {
                        return true;
                    }
                }
            }
            return false;
        }

        private static bool HasRepositoryForAttributeSyntax(ClassDeclarationSyntax classDeclaration)
        {
            foreach (var attrList in classDeclaration.AttributeLists)
            {
                foreach (var attr in attrList.Attributes)
                {
                    var nameText = attr.Name.ToString();
                    if (nameText is "RepositoryFor" or "RepositoryForAttribute")
                    {
                        return true;
                    }
                }
            }
            return false;
        }

        private static bool HasRepositoryForAttribute(INamedTypeSymbol type)
        {
            var attributes = type.GetAttributes();
#if DEBUG
            System.Diagnostics.Debug.WriteLine($"Class {type.Name} has {attributes.Length} attributes:");
            foreach (var attr in attributes)
            {
                System.Diagnostics.Debug.WriteLine($"  - {attr.AttributeClass?.Name} ({attr.AttributeClass?.ToDisplayString()})");
            }
#endif

            var hasAttr = attributes.Any(attr => attr.AttributeClass?.Name == "RepositoryForAttribute" || attr.AttributeClass?.Name == "RepositoryFor");
#if DEBUG
            System.Diagnostics.Debug.WriteLine(hasAttr
                ? $"Found RepositoryFor attribute on {type.Name}"
                : $"No RepositoryFor attribute found on {type.Name}");
#endif
            return hasAttr;
        }
    }
}


