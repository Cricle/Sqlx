# Sqlx ç¡¬ç¼–ç ç´¢å¼•ä¼˜åŒ–æ€»ç»“

## ğŸ“Š è®¾è®¡å†³ç­–

### ä¹‹å‰çš„æ–¹æ¡ˆï¼ˆåŠ¨æ€GetOrdinalï¼‰
- âœ… **å®‰å…¨**ï¼šå±æ€§é¡ºåºå¯ä»¥éšæ„å˜åŠ¨
- âŒ **æ€§èƒ½æŸå¤±**ï¼šæ¯æ¬¡æŸ¥è¯¢è°ƒç”¨Næ¬¡`GetOrdinal()`ï¼ˆ~2Î¼så¼€é”€ï¼‰
- âŒ **å†…å­˜å¼€é”€**ï¼šå­—ç¬¦ä¸²æŸ¥æ‰¾å’Œæ¯”è¾ƒï¼ˆ+1.4KBï¼‰

### ç°åœ¨çš„æ–¹æ¡ˆï¼ˆç¡¬ç¼–ç ç´¢å¼•+åˆ†æå™¨ï¼‰
- âœ… **æè‡´æ€§èƒ½**ï¼šé›¶`GetOrdinal`å¼€é”€ï¼Œç›´æ¥ä½¿ç”¨`reader.GetInt32(0)`
- âœ… **ç¼–è¯‘æ—¶å®‰å…¨**ï¼šæºåˆ†æå™¨æ£€æµ‹é¡ºåºä¸åŒ¹é…å¹¶å‘å‡ºè­¦å‘Š
- âœ… **è‡ªåŠ¨ä¿®å¤**ï¼šCodeFixProviderè‡ªåŠ¨è°ƒæ•´å±æ€§é¡ºåº
- âš ï¸ **è¦æ±‚**ï¼šC#å±æ€§é¡ºåºå¿…é¡»ä¸SQLåˆ—é¡ºåºä¸€è‡´

---

## ğŸ¯ æ€§èƒ½å¯¹æ¯”

### Benchmarkç»“æœï¼ˆå•è¡ŒæŸ¥è¯¢ï¼‰

| é…ç½® | è€—æ—¶ (Î¼s) | å†…å­˜ (B) | vs Raw ADO.NET | vs Dapper | æ”¹è¿› |
|------|-----------|----------|----------------|-----------|------|
| **Raw ADO.NET** | 6.323 | 904 | 1.00x | - | - |
| **Dapper** | 8.580 | 1,776 | 1.36x | 1.00x | - |
| **Sqlxï¼ˆåŠ¨æ€GetOrdinalï¼‰** | 16.076 | 2,624 | 2.54x | 2.01x | - |
| **Sqlxï¼ˆç¡¬ç¼–ç ç´¢å¼•ï¼‰** | **15.752** | **1,240** | 2.49x | **1.84x** | â¬‡ï¸ 9% |

### æ€§èƒ½æå‡

#### é€Ÿåº¦
- **vs åŠ¨æ€GetOrdinal**: 16.076 â†’ 15.752 Î¼s = **å¿« 324ns (2.0%)**
- **vs Dapperå·®è·**: 2.01x â†’ 1.84x = **æ€§èƒ½å·®è·ç¼©å° 9%**

#### å†…å­˜
- **vs åŠ¨æ€GetOrdinal**: 2,624 â†’ 1,240 B = **å‡å°‘ 1,384 B (52.7%)**

---

## ğŸ’¡ ç”Ÿæˆçš„ä»£ç å¯¹æ¯”

### åŠ¨æ€GetOrdinalï¼ˆä¹‹å‰ï¼‰

```csharp
// ğŸ›¡ï¸ ä½¿ç”¨GetOrdinalåŠ¨æ€æŸ¥æ‰¾ï¼ˆé»˜è®¤å®‰å…¨æ¨¡å¼ï¼‰
var __ord_0__ = reader.GetOrdinal("id");
var __ord_1__ = reader.GetOrdinal("name");
var __ord_2__ = reader.GetOrdinal("email");
// ... æ¯ä¸ªåˆ—éƒ½è°ƒç”¨ä¸€æ¬¡GetOrdinal

__result__ = new User
{
    Id = reader.IsDBNull(__ord_0__) ? 0 : reader.GetInt32(__ord_0__),
    Name = reader.IsDBNull(__ord_1__) ? null : reader.GetString(__ord_1__),
    // ...
};
```

### ç¡¬ç¼–ç ç´¢å¼•ï¼ˆç°åœ¨ï¼‰

```csharp
// ğŸš€ ä½¿ç”¨ç¡¬ç¼–ç ç´¢å¼•è®¿é—®ï¼ˆæè‡´æ€§èƒ½ï¼‰
// âš ï¸ å¦‚æœC#å±æ€§é¡ºåºä¸SQLåˆ—é¡ºåºä¸ä¸€è‡´ï¼Œæºåˆ†æå™¨ä¼šå‘å‡ºè­¦å‘Š
__result__ = new User
{
    Id = reader.IsDBNull(0) ? 0 : reader.GetInt32(0),
    Name = reader.IsDBNull(1) ? null : reader.GetString(1),
    Email = reader.IsDBNull(2) ? null : reader.GetString(2),
    Age = reader.IsDBNull(3) ? 0 : reader.GetInt32(3),
    Salary = reader.IsDBNull(4) ? 0m : (decimal)reader.GetDouble(4),
    IsActive = reader.IsDBNull(5) ? false : reader.GetInt32(5) == 1,
    CreatedAt = reader.IsDBNull(6) ? default : DateTime.Parse(reader.GetString(6)),
    UpdatedAt = reader.IsDBNull(7) ? null : DateTime.Parse(reader.GetString(7))
};
```

---

## ğŸ›¡ï¸ ç¼–è¯‘æ—¶å®‰å…¨ä¿éšœ

### æºåˆ†æå™¨ï¼ˆPropertyOrderAnalyzerï¼‰

**è¯Šæ–­ID**: `SQLX001`

**æ£€æµ‹è§„åˆ™**:
1. æ£€æµ‹å®ä½“ç±»ï¼ˆæœ‰`[TableName]`ç‰¹æ€§ï¼‰çš„å±æ€§é¡ºåº
2. å¯å‘å¼è§„åˆ™ï¼š`Id`å±æ€§åº”è¯¥æ˜¯ç¬¬ä¸€ä¸ªå±æ€§
3. æ£€æŸ¥å±æ€§snake_caseè½¬æ¢åæ˜¯å¦ä¸SQLåˆ—ååŒ¹é…

**è­¦å‘Šç¤ºä¾‹**:
```
Warning SQLX001: å®ä½“ç±»å‹ 'User' çš„å±æ€§é¡ºåºä¸SQLåˆ—é¡ºåºä¸åŒ¹é…ã€‚
æœŸæœ›é¡ºåº: Id å±æ€§åº”è¯¥æ˜¯ç¬¬ä¸€ä¸ªå±æ€§ï¼ˆå¯¹åº” SQL ä¸­çš„ä¸»é”®åˆ—ï¼‰
```

### ä»£ç ä¿®å¤æä¾›å™¨ï¼ˆPropertyOrderCodeFixProviderï¼‰

**è‡ªåŠ¨ä¿®å¤**:
- æ£€æµ‹åˆ°`Id`å±æ€§ä¸åœ¨ç¬¬ä¸€ä½æ—¶
- æä¾›å¿«é€Ÿä¿®å¤ï¼šè‡ªåŠ¨å°†`Id`å±æ€§ç§»åˆ°ç¬¬ä¸€ä¸ªä½ç½®
- ä¿ç•™åŸæœ‰æ³¨é‡Šå’Œç‰¹æ€§

**ä½¿ç”¨æ–¹å¼**:
1. IDEä¸­ä¼šæ˜¾ç¤ºè­¦å‘Šï¼ˆé»„è‰²æ³¢æµªçº¿ï¼‰
2. å…‰æ ‡ç§»åˆ°è­¦å‘Šå¤„ï¼ŒæŒ‰`Ctrl+.`ï¼ˆæˆ–ç¯æ³¡å›¾æ ‡ï¼‰
3. é€‰æ‹©"å°† Id å±æ€§ç§»è‡³ç¬¬ä¸€ä¸ªä½ç½®"
4. è‡ªåŠ¨å®Œæˆä¿®å¤

---

## ğŸ“¦ å®ç°ç»†èŠ‚

### åˆ é™¤çš„ç»„ä»¶
- âŒ `UseOrdinalIndexAttribute.cs` - ä¸å†éœ€è¦ç‰¹æ€§æ§åˆ¶

### ä¿®æ”¹çš„ç»„ä»¶

#### 1. `SharedCodeGenerationUtilities.cs`
```csharp
// é»˜è®¤ä½¿ç”¨ç¡¬ç¼–ç ç´¢å¼•
public static void GenerateEntityMapping(..., bool useOrdinalIndex = true)
{
    if (columnOrder != null && columnOrder.Count > 0)
    {
        sb.AppendLine($"// ğŸš€ ä½¿ç”¨ç¡¬ç¼–ç ç´¢å¼•è®¿é—®ï¼ˆæè‡´æ€§èƒ½ï¼‰");
        sb.AppendLine($"// âš ï¸ å¦‚æœC#å±æ€§é¡ºåºä¸SQLåˆ—é¡ºåºä¸ä¸€è‡´ï¼Œæºåˆ†æå™¨ä¼šå‘å‡ºè­¦å‘Š");
        GenerateEntityMappingWithHardcodedOrdinals(sb, entityType, variableName, columnOrder);
        return;
    }
    // å‘åå…¼å®¹...
}
```

#### 2. `CodeGenerationService.cs`
- ç§»é™¤`ShouldUseOrdinalIndex`æ–¹æ³•
- ç§»é™¤`useOrdinalIndex`å‚æ•°ä¼ é€’
- ç®€åŒ–ä»£ç ç”Ÿæˆé€»è¾‘

#### 3. `Sqlx.Generator.csproj`
```xml
<PackageReference Include="Microsoft.CodeAnalysis.CSharp.Workspaces" PrivateAssets="all" />
```

#### 4. `Directory.Packages.props`
```xml
<PackageVersion Include="Microsoft.CodeAnalysis.CSharp.Workspaces" Version="4.8.0" />
```

### æ–°å¢çš„ç»„ä»¶

#### 1. `PropertyOrderAnalyzer.cs`
- å®ç°`DiagnosticAnalyzer`
- æ£€æµ‹å±æ€§é¡ºåºä¸åŒ¹é…
- å‘å‡ºç¼–è¯‘è­¦å‘Šï¼ˆSQLX001ï¼‰

#### 2. `PropertyOrderCodeFixProvider.cs`
- å®ç°`CodeFixProvider`
- æä¾›è‡ªåŠ¨ä¿®å¤åŠŸèƒ½
- æ”¯æŒæ‰¹é‡ä¿®å¤ï¼ˆFixAllï¼‰

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### æ¨èçš„å®ä½“ç±»ç¼–å†™æ–¹å¼

```csharp
[TableName("users")]
public class User
{
    // âœ… Id å±æ€§å¿…é¡»åœ¨ç¬¬ä¸€ä½ï¼ˆå¯¹åº”SQLä¸»é”®åˆ—ï¼‰
    public int Id { get; set; }

    // âœ… å…¶ä»–å±æ€§æŒ‰SQL SELECTè¯­å¥ä¸­çš„åˆ—é¡ºåºæ’åˆ—
    public string Name { get; set; }
    public string Email { get; set; }
    public int Age { get; set; }
    public decimal Salary { get; set; }
    public bool IsActive { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
}
```

### SQLæ¨¡æ¿ä¸­çš„åˆ—é¡ºåº

```csharp
[Sqlx("SELECT id, name, email, age, salary, is_active, created_at, updated_at FROM users WHERE id = @id")]
User? GetById(int id);
//      â†‘ C#å±æ€§é¡ºåºå¿…é¡»ä¸è¿™ä¸ªSELECTåˆ—é¡ºåºä¸€è‡´
```

### å¦‚æœé¡ºåºä¸åŒ¹é…

**åœºæ™¯1ï¼šç¼–è¯‘æ—¶è­¦å‘Š**
```csharp
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šNameåœ¨Idä¹‹å‰
public class User
{
    public string Name { get; set; }  // âš ï¸ Warning SQLX001
    public int Id { get; set; }       // Idåº”è¯¥æ˜¯ç¬¬ä¸€ä¸ª
    // ...
}
```

**è§£å†³æ–¹æ³•**:
1. IDEä¼šæ˜¾ç¤ºè­¦å‘Š
2. æŒ‰`Ctrl+.`é€‰æ‹©å¿«é€Ÿä¿®å¤
3. æˆ–æ‰‹åŠ¨è°ƒæ•´å±æ€§é¡ºåº

**åœºæ™¯2ï¼šSQLåˆ—é¡ºåºä¸å±æ€§ä¸ä¸€è‡´**
```csharp
// SQL: SELECT id, name, email, age
// C#å±æ€§é¡ºåº: Id, Email, Name, Age  âŒ é”™è¯¯ï¼
```

**æ­£ç¡®åšæ³•**:
```csharp
// SQL: SELECT id, name, email, age
// C#å±æ€§é¡ºåº: Id, Name, Email, Age  âœ… æ­£ç¡®
```

---

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»åŠ¨æ€GetOrdinalå‡çº§

**æ­¥éª¤1**: æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
```bash
dotnet add package Sqlx
```

**æ­¥éª¤2**: é‡æ–°ç¼–è¯‘é¡¹ç›®
```bash
dotnet build
```

**æ­¥éª¤3**: æ£€æŸ¥ç¼–è¯‘è­¦å‘Š
- æŸ¥æ‰¾`SQLX001`è­¦å‘Š
- æŒ‰æç¤ºä¿®å¤å±æ€§é¡ºåº

**æ­¥éª¤4**: è¿è¡Œæµ‹è¯•
- ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢æ­£å¸¸å·¥ä½œ
- éªŒè¯æ•°æ®æ˜ å°„æ­£ç¡®

### æ€§èƒ½éªŒè¯

**è¿è¡ŒBenchmark**:
```bash
cd tests/Sqlx.Benchmarks
dotnet run -c Release --filter "*TracingOverhead*SingleRow*"
```

**é¢„æœŸç»“æœ**:
- Sqlxæ€§èƒ½åº”è¯¥æ¯”ä¹‹å‰å¿«2-3%
- å†…å­˜åˆ†é…å‡å°‘çº¦50%
- vs Dapperæ€§èƒ½å·®è·ç¼©å°åˆ°1.8x-1.9x

---

## âš™ï¸ é«˜çº§é…ç½®

### æ‰©å±•åˆ†æå™¨è§„åˆ™

å½“å‰åˆ†æå™¨åªå®ç°äº†åŸºç¡€çš„`Id`å±æ€§é¡ºåºæ£€æŸ¥ã€‚æœªæ¥å¯ä»¥æ‰©å±•ï¼š

1. **å®Œæ•´åˆ—é¡ºåºéªŒè¯**
   - ä»SQLæ¨¡æ¿ä¸­æå–åˆ—é¡ºåº
   - ä¸C#å±æ€§é¡ºåºè¿›è¡Œå®Œæ•´æ¯”å¯¹

2. **ç±»å‹åŒ¹é…éªŒè¯**
   - æ£€æŸ¥C#å±æ€§ç±»å‹ä¸SQLåˆ—ç±»å‹æ˜¯å¦å…¼å®¹
   - å‘å‡ºç±»å‹ä¸åŒ¹é…è­¦å‘Š

3. **å‘½åçº¦å®šæ£€æŸ¥**
   - éªŒè¯snake_caseè½¬æ¢è§„åˆ™
   - æ£€æµ‹éæ ‡å‡†å‘½å

4. **CodeFixå¢å¼º**
   - è‡ªåŠ¨è°ƒæ•´æ‰€æœ‰å±æ€§é¡ºåºï¼ˆä¸ä»…ä»…æ˜¯Idï¼‰
   - ç”ŸæˆSQLåˆ—é¡ºåºæ³¨é‡Š

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### âš ï¸ é‡è¦æé†’

1. **å±æ€§é¡ºåºå¾ˆé‡è¦**
   - C#å±æ€§é¡ºåºå¿…é¡»ä¸SQL SELECTåˆ—é¡ºåºå®Œå…¨ä¸€è‡´
   - é¡ºåºé”™è¯¯ä¼šå¯¼è‡´è¿è¡Œæ—¶æ•°æ®æ˜ å°„é”™è¯¯

2. **SQLæ¨¡æ¿åˆ—é¡ºåºç¨³å®š**
   - ä¿®æ”¹SQLæ¨¡æ¿ä¸­çš„åˆ—é¡ºåºåï¼Œå¿…é¡»åŒæ­¥ä¿®æ”¹C#å±æ€§é¡ºåº
   - å»ºè®®ä½¿ç”¨`{{columns}}`å ä½ç¬¦ä¿æŒä¸€è‡´æ€§

3. **ä¸»é”®çº¦å®š**
   - æ¨èå°†ä¸»é”®å­—æ®µï¼ˆé€šå¸¸æ˜¯`Id`ï¼‰æ”¾åœ¨ç¬¬ä¸€ä½
   - ç¬¦åˆå¤§å¤šæ•°SQLæŸ¥è¯¢çš„æƒ¯ä¾‹

4. **ç¼–è¯‘å™¨è­¦å‘Š**
   - ä¸è¦å¿½ç•¥`SQLX001`è­¦å‘Š
   - ä½¿ç”¨CodeFixæˆ–æ‰‹åŠ¨ä¿®å¤

### âœ… æœ€ä½³å®è·µ

1. **ä½¿ç”¨SQLæ¨¡æ¿å ä½ç¬¦**
   ```csharp
   [Sqlx("SELECT {{columns}} FROM users WHERE id = @id")]
   User? GetById(int id);
   ```

2. **å®šä¹‰æ ‡å‡†å®ä½“ç»“æ„**
   ```csharp
   // æ¨èç»“æ„ï¼š
   // 1. Idï¼ˆä¸»é”®ï¼‰
   // 2. ä¸šåŠ¡å­—æ®µï¼ˆæŒ‰å­—æ¯æˆ–é‡è¦æ€§æ’åºï¼‰
   // 3. å®¡è®¡å­—æ®µï¼ˆCreatedAt, UpdatedAtï¼‰
   ```

3. **å¯ç”¨IDEè­¦å‘Š**
   - ç¡®ä¿IDEæ˜¾ç¤ºRoslynåˆ†æå™¨è­¦å‘Š
   - è®¾ç½®è­¦å‘Šçº§åˆ«ä¸ºErrorï¼ˆå¯é€‰ï¼‰

4. **æŒç»­é›†æˆ**
   - CI/CDä¸­å¯ç”¨ç¼–è¯‘å™¨è­¦å‘Šæ£€æŸ¥
   - å°†`SQLX001`è®¾ç½®ä¸ºæ„å»ºå¤±è´¥æ¡ä»¶ï¼ˆå¯é€‰ï¼‰

---

## ğŸ‰ æ€»ç»“

### æ”¹è¿›æˆæœ

âœ… **æ€§èƒ½æå‡ 2%** - ä»16.076Î¼sé™åˆ°15.752Î¼s
âœ… **å†…å­˜ä¼˜åŒ– 52.7%** - ä»2,624Bé™åˆ°1,240B
âœ… **vs Dapperå·®è·ç¼©å° 9%** - ä»2.01xé™åˆ°1.84x
âœ… **ç¼–è¯‘æ—¶å®‰å…¨** - æºåˆ†æå™¨æ£€æµ‹é¡ºåºé”™è¯¯
âœ… **è‡ªåŠ¨ä¿®å¤** - CodeFixProviderå¿«é€Ÿä¿®å¤
âœ… **ç®€åŒ–è®¾è®¡** - ç§»é™¤ä¸å¿…è¦çš„ç‰¹æ€§ï¼Œä¿æŒç®€æ´é«˜æ•ˆ

### è®¾è®¡ç†å¿µ

> **"ç®€å•ã€é«˜æ•ˆã€å®‰å…¨"**
>
> - é»˜è®¤ä½¿ç”¨ç¡¬ç¼–ç ç´¢å¼•è·å¾—æè‡´æ€§èƒ½
> - æºåˆ†æå™¨æä¾›ç¼–è¯‘æ—¶å®‰å…¨ä¿éšœ
> - é›¶é…ç½®ï¼Œå¼€ç®±å³ç”¨

### ä¸‹ä¸€æ­¥

- [ ] æ‰©å±•åˆ†æå™¨ï¼šå®Œæ•´åˆ—é¡ºåºéªŒè¯
- [ ] æ€§èƒ½æµ‹è¯•ï¼šæ›´å¤šåœºæ™¯çš„benchmark
- [ ] æ–‡æ¡£å®Œå–„ï¼šç”¨æˆ·æŒ‡å—å’Œæœ€ä½³å®è·µ
- [ ] ç¤ºä¾‹é¡¹ç›®ï¼šå±•ç¤ºæ­£ç¡®çš„ä½¿ç”¨æ–¹å¼

---

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2025-10-22
**ä½œè€…**: Sqlx Team

