# Sqlx Quick Actions (å¿«é€Ÿæ“ä½œ)

> **åŠŸèƒ½**: ä»£ç ç”Ÿæˆå’Œé‡æ„å·¥å…·  
> **çŠ¶æ€**: âœ… å®ç°å®Œæˆ  
> **ä¼˜å…ˆçº§**: P0

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

Quick Actions æä¾›äº†ä¸€å¥—åŸºäº Roslyn çš„ä»£ç é‡æ„å·¥å…·ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿç”Ÿæˆ Sqlx ä»“å‚¨ä»£ç å’Œ CRUD æ–¹æ³•ã€‚

---

## ğŸš€ åŠŸèƒ½åˆ—è¡¨

### 1. ç”Ÿæˆä»“å‚¨ (Generate Repository)

**è§¦å‘æ¡ä»¶**: åœ¨å®ä½“ç±»ä¸Šå³é”®

**åŠŸèƒ½**: è‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„ä»“å‚¨æ¥å£å’Œå®ç°ç±»

**ç”Ÿæˆå†…å®¹**:
- ä»“å‚¨æ¥å£ (`I{Entity}Repository`)
- ä»“å‚¨å®ç°ç±» (`{Entity}Repository`)
- 8ä¸ªåŸºç¡€ CRUD æ–¹æ³•

**ç¤ºä¾‹**:

```csharp
// åŸå§‹å®ä½“
public class User
{
    public long Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
}

// å³é”®ç‚¹å‡» User ç±» â†’ "Generate Sqlx Repository for 'User'"

// ç”Ÿæˆ: IUserRepository.cs
[SqlDefine(SqlDefineTypes.SQLite)]
[RepositoryFor(typeof(User))]
public interface IUserRepository
{
    Task<User?> GetByIdAsync(long id, CancellationToken ct = default);
    Task<List<User>> GetAllAsync(CancellationToken ct = default);
    Task<long> InsertAsync(User entity, CancellationToken ct = default);
    Task<int> UpdateAsync(User entity, CancellationToken ct = default);
    Task<int> DeleteAsync(long id, CancellationToken ct = default);
    Task<List<User>> QueryAsync(Expression<Func<User, bool>> predicate, CancellationToken ct = default);
    Task<int> CountAsync(CancellationToken ct = default);
    Task<bool> ExistsAsync(long id, CancellationToken ct = default);
}

// ç”Ÿæˆ: UserRepository.cs
public partial class UserRepository(DbConnection connection) : IUserRepository
{
    private readonly DbConnection _connection = connection;
    // Implementation is auto-generated by Sqlx source generator
}
```

---

### 2. æ·»åŠ  CRUD æ–¹æ³• (Add CRUD Methods)

**è§¦å‘æ¡ä»¶**: åœ¨ä»“å‚¨æ¥å£ä¸Šå³é”®

**åŠŸèƒ½**: å‘ç°æœ‰ä»“å‚¨æ¥å£æ·»åŠ  CRUD æ–¹æ³•

**å¯é€‰æ–¹æ³•**:
- `Add GetById method` - æ ¹æ®IDè·å–
- `Add GetAll method` - è·å–æ‰€æœ‰
- `Add Insert method` - æ’å…¥
- `Add Update method` - æ›´æ–°
- `Add Delete method` - åˆ é™¤
- `Add Query method (Expression)` - è¡¨è¾¾å¼æŸ¥è¯¢
- `Add Count method` - è®¡æ•°
- `Add all CRUD methods` - ä¸€æ¬¡æ·»åŠ æ‰€æœ‰æ–¹æ³•

**ç¤ºä¾‹**:

```csharp
// åŸå§‹æ¥å£
[SqlDefine(SqlDefineTypes.SQLite)]
[RepositoryFor(typeof(Product))]
public interface IProductRepository
{
    // ç©ºæ¥å£
}

// å³é”®ç‚¹å‡»æ¥å£å â†’ "Add all CRUD methods"

// ç»“æœï¼šè‡ªåŠ¨æ·»åŠ æ‰€æœ‰æ–¹æ³•
public interface IProductRepository
{
    [SqlTemplate("SELECT {{columns}} FROM {{table}} WHERE id = @id")]
    Task<Product?> GetByIdAsync(TKey id, CancellationToken ct = default);

    [SqlTemplate("SELECT {{columns}} FROM {{table}}")]
    Task<List<Product>> GetAllAsync(CancellationToken ct = default);

    [SqlTemplate("INSERT INTO {{table}} {{values}}")]
    [ReturnInsertedId]
    Task<TKey> InsertAsync(Product entity, CancellationToken ct = default);

    [SqlTemplate("UPDATE {{table}} {{set}} WHERE id = @id")]
    Task<int> UpdateAsync(Product entity, CancellationToken ct = default);

    [SqlTemplate("DELETE FROM {{table}} WHERE id = @id")]
    Task<int> DeleteAsync(TKey id, CancellationToken ct = default);

    [SqlTemplate("SELECT {{columns}} FROM {{table}} {{where}}")]
    Task<List<Product>> QueryAsync([ExpressionToSql] Expression<Func<Product, bool>> predicate, CancellationToken ct = default);

    [SqlTemplate("SELECT COUNT(*) FROM {{table}}")]
    Task<int> CountAsync(CancellationToken ct = default);
}
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å¿«é€Ÿåˆ›å»ºæ–°ä»“å‚¨

```csharp
// æ­¥éª¤1: åˆ›å»ºå®ä½“
public class Order
{
    public long Id { get; set; }
    public DateTime OrderDate { get; set; }
    public decimal TotalAmount { get; set; }
}

// æ­¥éª¤2: å³é”® Order ç±»
// é€‰æ‹©: "Generate Sqlx Repository for 'Order'"

// æ­¥éª¤3: è‡ªåŠ¨ç”Ÿæˆ IOrderRepository å’Œ OrderRepository
```

### åœºæ™¯ 2: æ‰©å±•ç°æœ‰ä»“å‚¨

```csharp
// å·²æœ‰åŸºç¡€ä»“å‚¨
public interface ICustomerRepository
{
    Task<Customer?> GetByIdAsync(long id);
}

// å³é”®æ¥å£å
// é€‰æ‹©: "Add Query method (Expression)"

// è‡ªåŠ¨æ·»åŠ :
[SqlTemplate("SELECT {{columns}} FROM {{table}} {{where}}")]
Task<List<Customer>> QueryAsync([ExpressionToSql] Expression<Func<Customer, bool>> predicate, CancellationToken ct = default);
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### æ¶æ„

```
QuickActions/
â”œâ”€â”€ GenerateRepositoryCodeAction.cs      // ç”Ÿæˆä»“å‚¨
â”œâ”€â”€ AddCrudMethodsCodeAction.cs          // æ·»åŠ æ–¹æ³•
â””â”€â”€ README.md                            // æœ¬æ–‡æ¡£
```

### å…³é”®æŠ€æœ¯

#### 1. Roslyn Code Refactoring

```csharp
[ExportCodeRefactoringProvider(LanguageNames.CSharp)]
public class GenerateRepositoryCodeAction : CodeRefactoringProvider
{
    public override async Task ComputeRefactoringsAsync(CodeRefactoringContext context)
    {
        // 1. è·å–è¯­æ³•èŠ‚ç‚¹
        var node = root.FindNode(context.Span);
        
        // 2. æ£€æµ‹ä¸Šä¸‹æ–‡ï¼ˆæ˜¯å¦åœ¨å®ä½“ç±»ä¸Šï¼‰
        var classDeclaration = node as ClassDeclarationSyntax;
        
        // 3. æ³¨å†Œä»£ç æ“ä½œ
        context.RegisterRefactoring(action);
    }
}
```

#### 2. è¯­ä¹‰åˆ†æ

```csharp
// è·å–ç±»çš„ç¬¦å·ä¿¡æ¯
var semanticModel = await document.GetSemanticModelAsync(cancellationToken);
var classSymbol = semanticModel.GetDeclaredSymbol(classDeclaration);

// åˆ†æå±æ€§æ‰¾åˆ°ä¸»é”®
var idProperty = classSymbol.GetMembers()
    .OfType<IPropertySymbol>()
    .FirstOrDefault(p => p.Name == "Id" || p.Name.EndsWith("Id"));
```

#### 3. ä»£ç ç”Ÿæˆ

```csharp
// ç”Ÿæˆæ¥å£ä»£ç 
private string GenerateInterfaceCode(string entityName, string interfaceName, string keyType)
{
    return $@"
    [SqlDefine(SqlDefineTypes.SQLite)]
    [RepositoryFor(typeof({entityName}))]
    public interface {interfaceName}
    {{
        // Generated methods...
    }}";
}
```

---

## ğŸ“ ç”Ÿæˆçš„ä»£ç æ¨¡æ¿

### æ¥å£æ¨¡æ¿

```csharp
[SqlDefine(SqlDefineTypes.SQLite)] // å¯é…ç½®æ•°æ®åº“ç±»å‹
[RepositoryFor(typeof(TEntity))]
public interface I{Entity}Repository
{
    // GetById
    [SqlTemplate("SELECT {{columns}} FROM {{table}} WHERE id = @id")]
    Task<TEntity?> GetByIdAsync(TKey id, CancellationToken ct = default);

    // GetAll
    [SqlTemplate("SELECT {{columns}} FROM {{table}}")]
    Task<List<TEntity>> GetAllAsync(CancellationToken ct = default);

    // Insert
    [SqlTemplate("INSERT INTO {{table}} {{values}}")]
    [ReturnInsertedId]
    Task<TKey> InsertAsync(TEntity entity, CancellationToken ct = default);

    // Update
    [SqlTemplate("UPDATE {{table}} {{set}} WHERE id = @id")]
    Task<int> UpdateAsync(TEntity entity, CancellationToken ct = default);

    // Delete
    [SqlTemplate("DELETE FROM {{table}} WHERE id = @id")]
    Task<int> DeleteAsync(TKey id, CancellationToken ct = default);

    // Query
    [SqlTemplate("SELECT {{columns}} FROM {{table}} {{where}}")]
    Task<List<TEntity>> QueryAsync([ExpressionToSql] Expression<Func<TEntity, bool>> predicate, CancellationToken ct = default);

    // Count
    [SqlTemplate("SELECT COUNT(*) FROM {{table}}")]
    Task<int> CountAsync(CancellationToken ct = default);

    // Exists
    [SqlTemplate("SELECT COUNT(*) FROM {{table}} WHERE id = @id")]
    Task<bool> ExistsAsync(TKey id, CancellationToken ct = default);
}
```

### å®ç°ç±»æ¨¡æ¿

```csharp
public partial class {Entity}Repository(DbConnection connection) : I{Entity}Repository
{
    private readonly DbConnection _connection = connection;

    // Implementation is auto-generated by Sqlx source generator
    // No manual code needed - the [SqlTemplate] attributes drive code generation
}
```

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. æ™ºèƒ½æ£€æµ‹

- **å®ä½“ç±»æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«å¯èƒ½çš„å®ä½“ç±»
- **ä¸»é”®è¯†åˆ«**: è‡ªåŠ¨æ£€æµ‹ Id å±æ€§
- **ç±»å‹æ¨æ–­**: æ ¹æ®ä¸»é”®ç±»å‹ç”Ÿæˆç›¸åº”ä»£ç 

### 2. çµæ´»é…ç½®

- **æ•°æ®åº“ç±»å‹**: é»˜è®¤ SQLiteï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹
- **å‘½åç©ºé—´**: ä½¿ç”¨å ä½ç¬¦ï¼Œéœ€æ‰‹åŠ¨è°ƒæ•´
- **æ–¹æ³•é€‰æ‹©**: å¯å•ç‹¬æ·»åŠ æˆ–æ‰¹é‡æ·»åŠ 

### 3. ä»£ç è´¨é‡

- **å®Œæ•´æ³¨é‡Š**: æ¯ä¸ªæ–¹æ³•éƒ½æœ‰ XML æ–‡æ¡£æ³¨é‡Š
- **å‚æ•°é»˜è®¤å€¼**: CancellationToken é»˜è®¤å€¼
- **è¿”å›ç±»å‹**: æ˜ç¡®çš„ Task è¿”å›ç±»å‹

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æ—¶æœº

âœ… **é€‚åˆä½¿ç”¨**:
- æ–°å»ºå®ä½“éœ€è¦CRUDæ“ä½œ
- å¿«é€ŸåŸå‹å¼€å‘
- æ ‡å‡†åŒ–ä»“å‚¨ç»“æ„

âŒ **ä¸é€‚åˆä½¿ç”¨**:
- å¤æ‚ä¸šåŠ¡é€»è¾‘
- éœ€è¦è‡ªå®šä¹‰SQL
- å¤šè¡¨å…³è”æŸ¥è¯¢ï¼ˆä½†å¯ä»¥ä½œä¸ºèµ·ç‚¹ï¼‰

### 2. ç”Ÿæˆåçš„è°ƒæ•´

ç”Ÿæˆçš„ä»£ç é€šå¸¸éœ€è¦ä»¥ä¸‹è°ƒæ•´ï¼š

```csharp
// 1. ä¿®æ”¹å‘½åç©ºé—´
namespace YourNamespace.Repositories  // â† æ”¹ä¸ºå®é™…å‘½åç©ºé—´

// 2. ä¿®æ”¹æ•°æ®åº“ç±»å‹
[SqlDefine(SqlDefineTypes.SQLite)]  // â† æ”¹ä¸ºå®é™…æ•°æ®åº“

// 3. æ ¹æ®éœ€è¦æ·»åŠ è‡ªå®šä¹‰æ–¹æ³•
Task<List<User>> GetActiveUsersAsync(CancellationToken ct = default);

// 4. è°ƒæ•´æ³›å‹ç±»å‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
Task<User?> GetByIdAsync(long id, ...)  // â† æ ¹æ®å®é™…ä¸»é”®ç±»å‹è°ƒæ•´
```

### 3. å‘½åçº¦å®š

- **å®ä½“**: `User`, `Product`, `Order`
- **æ¥å£**: `IUserRepository`, `IProductRepository`
- **å®ç°**: `UserRepository`, `ProductRepository`
- **ä¸»é”®**: `Id` æˆ– `{Entity}Id`

---

## ğŸš€ æ€§èƒ½è€ƒè™‘

### ä»£ç ç”Ÿæˆæ€§èƒ½

- **è§¦å‘æ—¶é—´**: < 100ms
- **ç”Ÿæˆæ—¶é—´**: < 200ms
- **å¯¹ IDE å½±å“**: æœ€å°

### ä¼˜åŒ–æªæ–½

1. **å»¶è¿Ÿè®¡ç®—**: åªåœ¨éœ€è¦æ—¶æ‰è®¡ç®—é‡æ„
2. **ç¼“å­˜æ£€æµ‹**: é¿å…é‡å¤çš„è¯­æ³•åˆ†æ
3. **å¼‚æ­¥æ“ä½œ**: æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„

---

## ğŸ› å·²çŸ¥é™åˆ¶

### 1. å‘½åç©ºé—´

**é—®é¢˜**: ç”Ÿæˆçš„ä»£ç ä½¿ç”¨å ä½ç¬¦å‘½åç©ºé—´  
**è§£å†³**: æ‰‹åŠ¨ä¿®æ”¹ä¸ºå®é™…å‘½åç©ºé—´  
**å½±å“**: ä½ï¼ˆä¸€æ¬¡æ€§ä¿®æ”¹ï¼‰

### 2. ä¸»é”®æ£€æµ‹

**é—®é¢˜**: åªæ£€æµ‹åä¸º `Id` æˆ–ä»¥ `Id` ç»“å°¾çš„å±æ€§  
**è§£å†³**: å¦‚æœä¸»é”®åä¸åŒï¼Œæ‰‹åŠ¨è°ƒæ•´ä»£ç   
**å½±å“**: ä½ï¼ˆç½•è§æƒ…å†µï¼‰

### 3. å¤æ‚ç±»å‹

**é—®é¢˜**: ä¸æ”¯æŒå¤åˆä¸»é”®  
**è§£å†³**: ç”Ÿæˆåæ‰‹åŠ¨è°ƒæ•´  
**å½±å“**: ä¸­ç­‰ï¼ˆéœ€è¦ä¸€äº›ä¿®æ”¹ï¼‰

---

## ğŸ“Š ä½¿ç”¨ç»Ÿè®¡ï¼ˆé¢„æœŸï¼‰

| æŒ‡æ ‡ | ç›®æ ‡å€¼ |
|------|--------|
| **èŠ‚çœæ—¶é—´** | æ¯ä¸ªä»“å‚¨ 5-10 åˆ†é’Ÿ |
| **ä»£ç è¡Œæ•°** | æ¯ä¸ªä»“å‚¨ 50-100 è¡Œ |
| **ä½¿ç”¨é¢‘ç‡** | æ¯å¤© 5-20 æ¬¡ |
| **ç”¨æˆ·æ»¡æ„åº¦** | 90%+ |

---

## ğŸ”® æœªæ¥æ”¹è¿›

### çŸ­æœŸï¼ˆv0.6.0ï¼‰

- [ ] æ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿
- [ ] æ™ºèƒ½å‘½åç©ºé—´æ£€æµ‹
- [ ] æ›´å¤šæ•°æ®åº“ç±»å‹é€‰é¡¹

### ä¸­æœŸï¼ˆv0.7.0ï¼‰

- [ ] å¤åˆä¸»é”®æ”¯æŒ
- [ ] æ‰¹é‡æ“ä½œæ–¹æ³•ç”Ÿæˆ
- [ ] è½¯åˆ é™¤æ”¯æŒ

### é•¿æœŸï¼ˆv0.8.0+ï¼‰

- [ ] å…³è”æŸ¥è¯¢ç”Ÿæˆ
- [ ] DTO æ˜ å°„ç”Ÿæˆ
- [ ] å•å…ƒæµ‹è¯•ç”Ÿæˆ

---

## ğŸ“ ç›¸å…³èµ„æº

### ä»£ç 

- [GenerateRepositoryCodeAction.cs](GenerateRepositoryCodeAction.cs)
- [AddCrudMethodsCodeAction.cs](AddCrudMethodsCodeAction.cs)

### æ–‡æ¡£

- [VS Extension Plan](../../../docs/VSCODE_EXTENSION_PLAN.md)
- [Build Instructions](../BUILD.md)

### å¤–éƒ¨é“¾æ¥

- [Roslyn Code Refactorings](https://docs.microsoft.com/en-us/dotnet/csharp/roslyn-sdk/tutorials/how-to-write-csharp-analyzer-code-fix)
- [VS SDK Documentation](https://docs.microsoft.com/en-us/visualstudio/extensibility/)

---

**çŠ¶æ€**: âœ… å®ç°å®Œæˆ  
**ç‰ˆæœ¬**: 0.5.0-dev  
**æœ€åæ›´æ–°**: 2025-10-29

