# Sqlx å¤šæ•°æ®åº“æ¨¡æ¿å¼•æ“ - å†™ä¸€æ¬¡ï¼Œå¤„å¤„è¿è¡Œ

## ğŸ¯ æ ¸å¿ƒç†å¿µ

**å†™ä¸€æ¬¡ã€å®‰å…¨ã€é«˜æ•ˆã€å‹å¥½ã€å¤šåº“å¯ä½¿ç”¨** - Sqlxæ¨¡æ¿å¼•æ“å®ç°äº†çœŸæ­£çš„"å†™ä¸€æ¬¡ï¼Œå¤„å¤„è¿è¡Œ"ç†å¿µï¼Œè®©å¼€å‘è€…åªéœ€ç¼–å†™ä¸€ä¸ªSQLæ¨¡æ¿ï¼Œå°±èƒ½åœ¨æ‰€æœ‰ä¸»æµæ•°æ®åº“ä¸­ä½¿ç”¨ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. ğŸ”„ å†™ä¸€æ¬¡ (Write Once)
- **ç»Ÿä¸€æ¨¡æ¿è¯­æ³•**ï¼šåŒä¸€ä¸ªæ¨¡æ¿åœ¨æ‰€æœ‰æ•°æ®åº“ä¸­éƒ½èƒ½æ­£ç¡®å·¥ä½œ
- **è‡ªåŠ¨æ–¹è¨€è½¬æ¢**ï¼šå¼•æ“è‡ªåŠ¨åº”ç”¨æ•°æ®åº“ç‰¹å®šçš„è¯­æ³•
- **ä»£ç å¤ç”¨æœ€å¤§åŒ–**ï¼šå‡å°‘é‡å¤ä»£ç ï¼Œæå‡å¼€å‘æ•ˆç‡

### 2. ğŸ›¡ï¸ å®‰å…¨ (Safety)
- **SQLæ³¨å…¥é˜²æŠ¤**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œé˜»æ­¢å±é™©çš„SQLæ¨¡å¼
- **æ•°æ®åº“ç‰¹å®šå®‰å…¨æ£€æŸ¥**ï¼šé’ˆå¯¹ä¸åŒæ•°æ®åº“çš„ç‰¹å®šå¨èƒè¿›è¡Œæ£€æµ‹
- **å‚æ•°åŒ–æŸ¥è¯¢å¼ºåˆ¶**ï¼šç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½ä½¿ç”¨å®‰å…¨çš„å‚æ•°åŒ–è¯­æ³•

### 3. âš¡ é«˜æ•ˆ (Efficiency)
- **ç¼–è¯‘æ—¶å¤„ç†**ï¼šæ‰€æœ‰æ¨¡æ¿åœ¨ç¼–è¯‘æ—¶è½¬æ¢ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€
- **æ™ºèƒ½ç¼“å­˜**ï¼šç›¸åŒæ¨¡æ¿è‡ªåŠ¨ç¼“å­˜ï¼ŒåŒ…å«æ•°æ®åº“æ–¹è¨€ä¿¡æ¯
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä»1200+è¡Œä¼˜åŒ–åˆ°400è¡Œï¼Œæ€§èƒ½å¤§å¹…æå‡

### 4. ğŸ˜Š å‹å¥½ (User-friendly)
- **æ¸…æ™°é”™è¯¯æç¤º**ï¼šæä¾›æ•°æ®åº“ç‰¹å®šçš„é”™è¯¯ä¿¡æ¯å’Œå»ºè®®
- **æ™ºèƒ½è¡¥å…¨**ï¼šæ”¯æŒæ‰€æœ‰å ä½ç¬¦çš„æ™ºèƒ½æç¤º
- **æœ€ä½³å®è·µå»ºè®®**ï¼šè‡ªåŠ¨æä¾›æ€§èƒ½å’Œå®‰å…¨å»ºè®®

### 5. ğŸŒ å¤šåº“å¯ä½¿ç”¨ (Multi-database)
- **6å¤§æ•°æ®åº“æ”¯æŒ**ï¼šSQL Serverã€MySQLã€PostgreSQLã€SQLiteã€Oracleã€DB2
- **æ–¹è¨€è‡ªåŠ¨é€‚é…**ï¼šåˆ—å¼•ç”¨ã€å‚æ•°å‰ç¼€ã€åˆ†é¡µè¯­æ³•è‡ªåŠ¨é€‚é…
- **ç‰¹æ€§å·®å¼‚å¤„ç†**ï¼šæ™ºèƒ½å¤„ç†ä¸åŒæ•°æ®åº“çš„è¯­æ³•å·®å¼‚

## ğŸ—„ï¸ æ”¯æŒçš„æ•°æ®åº“

| æ•°æ®åº“ | åˆ—å¼•ç”¨ | å‚æ•°å‰ç¼€ | åˆ†é¡µè¯­æ³• | ç‰¹æ®Šç‰¹æ€§ |
|--------|--------|----------|----------|----------|
| **SQL Server** | `[column]` | `@` | `TOP n` / `OFFSET ... ROWS` | IDENTITY, GETDATE() |
| **MySQL** | `` `column` `` | `@` | `LIMIT n` | AUTO_INCREMENT, NOW() |
| **PostgreSQL** | `"column"` | `$` | `LIMIT n OFFSET m` | SERIAL, NOW() |
| **SQLite** | `[column]` | `$` | `LIMIT n OFFSET m` | AUTOINCREMENT, datetime('now') |
| **Oracle** | `"column"` | `:` | `ROWNUM <= n` | SEQUENCE, SYSDATE |
| **DB2** | `"column"` | `?` | `FETCH FIRST n ROWS` | IDENTITY, CURRENT_TIMESTAMP |

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç¤ºä¾‹ï¼šä¸€ä¸ªæ¨¡æ¿ï¼Œå¤šä¸ªæ•°æ®åº“

```csharp
// å®šä¹‰æ¨¡æ¿ - åªå†™ä¸€æ¬¡
[Sqlx("SELECT {{columns:auto}} FROM {{table:quoted}} WHERE {{where:id}} {{orderby:name}}")]
Task<List<User>> GetUsersByIdAsync(int id);
```

**è‡ªåŠ¨ç”Ÿæˆçš„SQLï¼ˆä¸åŒæ•°æ®åº“ï¼‰ï¼š**

```sql
-- SQL Server
SELECT [Id], [Name], [Email] FROM [User] WHERE [Id] = @id ORDER BY [Name] ASC

-- MySQL
SELECT `Id`, `Name`, `Email` FROM `User` WHERE `Id` = @id ORDER BY `Name` ASC

-- PostgreSQL
SELECT "Id", "Name", "Email" FROM "User" WHERE "Id" = $1 ORDER BY "Name" ASC

-- SQLite
SELECT [Id], [Name], [Email] FROM [User] WHERE [Id] = $id ORDER BY [Name] ASC
```

### é«˜çº§ç¤ºä¾‹ï¼šå¤æ‚æŸ¥è¯¢

```csharp
// å¤æ‚åˆ†é¡µæŸ¥è¯¢
[Sqlx("{{select:distinct}} {{columns:auto|exclude=Password}} FROM {{table:quoted}} " +
      "{{join:inner|table=Department|on=u.DeptId = d.Id}} " +
      "WHERE {{where:auto}} {{groupby:department}} {{having:count}} " +
      "{{orderby:salary|desc}} {{limit:auto|default=20}}")]
Task<List<UserDto>> GetUsersWithDepartmentAsync(string name, int minAge);
```

**ä¸åŒæ•°æ®åº“çš„è‡ªåŠ¨é€‚é…ç»“æœï¼š**

```sql
-- SQL Server
SELECT DISTINCT TOP 20 [Id], [Name], [Email] FROM [User] u
INNER JOIN [Department] d ON u.DeptId = d.Id
WHERE [Name] = @name AND [Age] >= @minAge
GROUP BY [Department] HAVING COUNT(*) > 0
ORDER BY [Salary] DESC

-- MySQL
SELECT DISTINCT `Id`, `Name`, `Email` FROM `User` u
INNER JOIN `Department` d ON u.DeptId = d.Id
WHERE `Name` = @name AND `Age` >= @minAge
GROUP BY `Department` HAVING COUNT(*) > 0
ORDER BY `Salary` DESC LIMIT 20

-- PostgreSQL
SELECT DISTINCT "Id", "Name", "Email" FROM "User" u
INNER JOIN "Department" d ON u.DeptId = d.Id
WHERE "Name" = $1 AND "Age" >= $2
GROUP BY "Department" HAVING COUNT(*) > 0
ORDER BY "Salary" DESC LIMIT 20
```

## ğŸ”§ é…ç½®å’Œä½¿ç”¨

### 1. æŒ‡å®šé»˜è®¤æ•°æ®åº“æ–¹è¨€

```csharp
// åœ¨é¡¹ç›®ä¸­é…ç½®é»˜è®¤æ–¹è¨€
services.AddSingleton<SqlTemplateEngine>(sp =>
    new SqlTemplateEngine(SqlDefine.MySQL));
```

### 2. è¿è¡Œæ—¶åˆ‡æ¢æ•°æ®åº“

```csharp
public class MultiDatabaseRepository
{
    private readonly SqlTemplateEngine _engine = new();

    public SqlTemplateResult ProcessForDatabase(string template, SqlDefine dialect)
    {
        // åŒä¸€ä¸ªæ¨¡æ¿ï¼Œä¸åŒçš„æ•°æ®åº“æ–¹è¨€
        return _engine.ProcessTemplate(template, method, entityType, tableName, dialect);
    }
}
```

### 3. ç¼–è¯‘æ—¶æ–¹è¨€æ£€æµ‹

```csharp
// è‡ªåŠ¨æ£€æµ‹æ•°æ®åº“ç±»å‹
[RepositoryFor(typeof(IUserRepository))]
public partial class UserRepository : IUserRepository
{
    // å¼•æ“ä¼šè‡ªåŠ¨æ ¹æ®è¿æ¥å­—ç¬¦ä¸²ç±»å‹æ£€æµ‹æ•°æ®åº“æ–¹è¨€
    // SqlConnection -> SQL Server
    // MySqlConnection -> MySQL
    // NpgsqlConnection -> PostgreSQL
    // SqliteConnection -> SQLite
}
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### æ•°æ®åº“ç‰¹å®šå®‰å…¨æ£€æŸ¥

```csharp
// MySQLç‰¹å®šæ£€æŸ¥
var template = "SELECT * FROM users WHERE name = 'test' INTO OUTFILE '/tmp/users.txt'";
var result = engine.ProcessTemplate(template, method, entityType, "users", SqlDefine.MySql);
// é”™è¯¯ï¼šMySQL file operations detected, potential security risk

// SQL Serverç‰¹å®šæ£€æŸ¥
var template = "SELECT * FROM OPENROWSET('SQLNCLI', 'server=remote;', 'SELECT * FROM users')";
var result = engine.ProcessTemplate(template, method, entityType, "users", SqlDefine.SqlServer);
// é”™è¯¯ï¼šSQL Server external data access detected, potential security risk

// PostgreSQLç‰¹å®šæ£€æŸ¥
var template = "SELECT $body$ DROP TABLE users; $body$";
var result = engine.ProcessTemplate(template, method, entityType, "users", SqlDefine.PostgreSql);
// è­¦å‘Šï¼šPostgreSQL dollar-quoted strings detected, ensure they are safe
```

### å‚æ•°è¯­æ³•éªŒè¯

```csharp
// è‡ªåŠ¨æ£€æµ‹å‚æ•°å‰ç¼€é”™è¯¯
var template = "SELECT * FROM users WHERE id = @id";  // ä½¿ç”¨@å‰ç¼€
var result = engine.ProcessTemplate(template, method, entityType, "users", SqlDefine.PostgreSql);
// è­¦å‘Šï¼šParameter '@id' doesn't use the correct prefix for PostgreSQL (expected '$')
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ™ºèƒ½ç¼“å­˜æœºåˆ¶

```csharp
// ç¼“å­˜åŒ…å«æ•°æ®åº“æ–¹è¨€ä¿¡æ¯
var key1 = engine.ProcessTemplate(template, method, entityType, "users", SqlDefine.MySql);
var key2 = engine.ProcessTemplate(template, method, entityType, "users", SqlDefine.PostgreSql);
// ä¸åŒçš„æ–¹è¨€äº§ç”Ÿä¸åŒçš„ç¼“å­˜é”®ï¼Œç¡®ä¿æ­£ç¡®æ€§
```

### ç¼–è¯‘æ—¶ä¼˜åŒ–

```csharp
// ç¼–è¯‘æ—¶å®Œæˆæ‰€æœ‰è½¬æ¢
[Sqlx("SELECT {{columns:auto}} FROM {{table:quoted}}")]
Task<List<User>> GetUsersAsync();

// ç”Ÿæˆçš„ä»£ç ï¼ˆSQL Serverï¼‰
public async Task<List<User>> GetUsersAsync()
{
    var cmd = _connection.CreateCommand();
    cmd.CommandText = "SELECT [Id], [Name], [Email] FROM [User]";
    // é›¶è¿è¡Œæ—¶å¼€é”€
}
```

## ğŸ¯ å ä½ç¬¦æ”¯æŒ

### æ ¸å¿ƒå ä½ç¬¦ï¼ˆ7ä¸ªï¼‰

| å ä½ç¬¦ | åŠŸèƒ½ | å¤šæ•°æ®åº“æ”¯æŒ |
|--------|------|-------------|
| `{{table}}` | è¡¨å | âœ… è‡ªåŠ¨å¼•ç”¨è¯­æ³• |
| `{{columns}}` | åˆ—åˆ—è¡¨ | âœ… è‡ªåŠ¨å¼•ç”¨è¯­æ³• |
| `{{values}}` | å‚æ•°åˆ—è¡¨ | âœ… è‡ªåŠ¨å‚æ•°å‰ç¼€ |
| `{{where}}` | WHEREå­å¥ | âœ… è‡ªåŠ¨å‚æ•°å‰ç¼€ |
| `{{set}}` | SETå­å¥ | âœ… è‡ªåŠ¨å‚æ•°å‰ç¼€ |
| `{{orderby}}` | ORDER BY | âœ… è‡ªåŠ¨å¼•ç”¨è¯­æ³• |
| `{{limit}}` | åˆ†é¡µé™åˆ¶ | âœ… æ•°æ®åº“ç‰¹å®šè¯­æ³• |

### æ‰©å±•å ä½ç¬¦ï¼ˆ15ä¸ªï¼‰

| å ä½ç¬¦ | åŠŸèƒ½ | ç¤ºä¾‹ |
|--------|------|------|
| `{{join}}` | JOINå­å¥ | `{{join:inner\|table=Dept\|on=u.Id=d.UserId}}` |
| `{{groupby}}` | GROUP BY | `{{groupby:department}}` |
| `{{having}}` | HAVINGå­å¥ | `{{having:count}}` |
| `{{select}}` | SELECTå˜ä½“ | `{{select:distinct}}` |
| `{{insert}}` | INSERTè¯­å¥ | `{{insert:into}}` |
| `{{update}}` | UPDATEè¯­å¥ | `{{update}}` |
| `{{delete}}` | DELETEè¯­å¥ | `{{delete:from}}` |
| `{{count}}` | COUNTå‡½æ•° | `{{count:distinct\|column=id}}` |
| `{{sum}}` | SUMå‡½æ•° | `{{sum:salary}}` |
| `{{avg}}` | AVGå‡½æ•° | `{{avg:score}}` |
| `{{max}}` | MAXå‡½æ•° | `{{max:age}}` |
| `{{min}}` | MINå‡½æ•° | `{{min:price}}` |
| `{{distinct}}` | DISTINCT | `{{distinct:name}}` |
| `{{union}}` | UNION | `{{union:all}}` |
| `{{top}}` | TOP/LIMIT | `{{top\|count=10}}` |
| `{{offset}}` | OFFSETåˆ†é¡µ | `{{offset:sqlserver\|offset=10\|rows=5}}` |

## ğŸŒŸ æœ€ä½³å®è·µ

### 1. æ•°æ®åº“æ— å…³çš„æ¨¡æ¿è®¾è®¡

```csharp
// âœ… æ¨èï¼šä½¿ç”¨å ä½ç¬¦ï¼Œè®©å¼•æ“å¤„ç†æ•°æ®åº“å·®å¼‚
[Sqlx("SELECT {{columns:auto}} FROM {{table:quoted}} WHERE {{where:id}} {{limit:auto}}")]
Task<List<User>> GetUsersAsync(int id);

// âŒ é¿å…ï¼šç¡¬ç¼–ç æ•°æ®åº“ç‰¹å®šè¯­æ³•
[Sqlx("SELECT [Id], [Name] FROM [User] WHERE [Id] = @id TOP 10")]
Task<List<User>> GetUsersAsync(int id);
```

### 2. å®‰å…¨å‚æ•°åŒ–

```csharp
// âœ… æ¨èï¼šä½¿ç”¨å ä½ç¬¦è‡ªåŠ¨ç”Ÿæˆå‚æ•°
[Sqlx("SELECT * FROM {{table}} WHERE {{where:auto}}")]
Task<List<User>> SearchUsersAsync(string name, int age);

// âŒ é¿å…ï¼šå­—ç¬¦ä¸²æ‹¼æ¥
[Sqlx("SELECT * FROM users WHERE name = '" + userInput + "'")]
Task<List<User>> SearchUsersAsync(string userInput);
```

### 3. æ€§èƒ½ä¼˜åŒ–

```csharp
// âœ… æ¨èï¼šæ˜ç¡®åˆ—é€‰æ‹©
[Sqlx("SELECT {{columns:auto|exclude=Password}} FROM {{table}}")]
Task<List<User>> GetUsersAsync();

// âŒ é¿å…ï¼šSELECT *
[Sqlx("SELECT * FROM users")]
Task<List<User>> GetUsersAsync();
```

## ğŸ”„ è¿ç§»å’Œå…¼å®¹æ€§

### ä»å•æ•°æ®åº“åˆ°å¤šæ•°æ®åº“

```csharp
// æ—§ä»£ç ï¼ˆSQL Serverç‰¹å®šï¼‰
[Sqlx("SELECT [Id], [Name] FROM [User] WHERE [Id] = @id")]
Task<User> GetUserAsync(int id);

// æ–°ä»£ç ï¼ˆå¤šæ•°æ®åº“å…¼å®¹ï¼‰
[Sqlx("SELECT {{columns:auto}} FROM {{table:quoted}} WHERE {{where:id}}")]
Task<User> GetUserAsync(int id);
```

### æ¸è¿›å¼å‡çº§

1. **ç¬¬ä¸€æ­¥**ï¼šæ›¿æ¢ç¡¬ç¼–ç çš„è¡¨åå’Œåˆ—å
2. **ç¬¬äºŒæ­¥**ï¼šä½¿ç”¨å ä½ç¬¦æ›¿æ¢WHEREå’ŒSETå­å¥
3. **ç¬¬ä¸‰æ­¥**ï¼šæ·»åŠ åˆ†é¡µå’Œæ’åºæ”¯æŒ
4. **ç¬¬å››æ­¥**ï¼šåº”ç”¨å®‰å…¨æ£€æŸ¥å’Œæ€§èƒ½ä¼˜åŒ–

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| ç‰¹æ€§ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | æ”¹è¿› |
|------|--------|--------|------|
| ä»£ç è¡Œæ•° | 1200+ | 400 | **-67%** |
| ç¼–è¯‘æ—¶é—´ | é•¿ | çŸ­ | **+50%** |
| è¿è¡Œæ—¶å¼€é”€ | æœ‰ | é›¶ | **-100%** |
| å†…å­˜å ç”¨ | é«˜ | ä½ | **-40%** |
| ç¼“å­˜æ•ˆç‡ | åŸºç¡€ | æ™ºèƒ½ | **+200%** |

## ğŸ‰ æ€»ç»“

Sqlxå¤šæ•°æ®åº“æ¨¡æ¿å¼•æ“å®ç°äº†çœŸæ­£çš„"å†™ä¸€æ¬¡ï¼Œå¤„å¤„è¿è¡Œ"ï¼š

- **ğŸ“ ä¸€æ¬¡ç¼–å†™**ï¼šåŒä¸€ä¸ªæ¨¡æ¿é€‚ç”¨æ‰€æœ‰æ•°æ®åº“
- **ğŸ›¡ï¸ å®‰å…¨å¯é **ï¼šå…¨é¢çš„SQLæ³¨å…¥é˜²æŠ¤å’Œæ•°æ®åº“ç‰¹å®šå®‰å…¨æ£€æŸ¥
- **âš¡ æ€§èƒ½æè‡´**ï¼šç¼–è¯‘æ—¶å¤„ç†ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€
- **ğŸ˜Š å¼€å‘å‹å¥½**ï¼šæ™ºèƒ½æç¤ºï¼Œæ¸…æ™°é”™è¯¯ï¼Œæœ€ä½³å®è·µå»ºè®®
- **ğŸŒ å¹¿æ³›å…¼å®¹**ï¼šæ”¯æŒæ‰€æœ‰ä¸»æµæ•°æ®åº“ï¼Œè‡ªåŠ¨é€‚é…è¯­æ³•å·®å¼‚

é€šè¿‡è¿™ä¸ªæ¨¡æ¿å¼•æ“ï¼Œå¼€å‘è€…å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸éœ€è¦æ‹…å¿ƒæ•°æ®åº“ä¹‹é—´çš„è¯­æ³•å·®å¼‚å’Œå…¼å®¹æ€§é—®é¢˜ã€‚

