# Requirements Document

## Introduction

This document defines the requirements for a lightweight SqlxContext feature that simplifies multi-repository management and unified transaction handling in Sqlx, while maintaining the library's core principles of high performance, zero reflection, and AOT compatibility.

## Glossary

- **SqlxContext**: A lightweight context class that manages multiple repositories and provides unified transaction management
- **Repository**: An implementation of ICrudRepository<TEntity, TKey> that provides CRUD operations for a specific entity
- **DbConnection**: The underlying database connection from ADO.NET
- **DbTransaction**: The underlying database transaction from ADO.NET
- **Unit_of_Work**: A pattern that maintains a list of objects affected by a business transaction and coordinates the writing out of changes
- **Source_Generator**: The Roslyn-based code generator that creates repository implementations at compile time
- **AOT**: Ahead-of-Time compilation, specifically Native AOT in .NET

## Requirements

### Requirement 1: Context Creation and Initialization

**User Story:** As a developer, I want to create a SqlxContext that manages multiple repositories, so that I can organize my data access code in a centralized way.

#### Acceptance Criteria

1. THE SqlxContext SHALL accept a DbConnection in its constructor
2. THE SqlxContext SHALL provide direct repository properties generated by the source generator
3. THE SqlxContext SHALL support both manual registration and source-generated registration
4. THE SqlxContext SHALL be thread-safe for read operations after initialization
5. WHERE source generation is used, THE SqlxContext SHALL include only repositories specified with [IncludeRepository] attributes on the context class

### Requirement 2: Repository Access

**User Story:** As a developer, I want to access repositories through the context using direct properties, so that I have a simple and intuitive interface.

#### Acceptance Criteria

1. THE SqlxContext SHALL provide direct repository properties generated at compile time
2. WHEN a repository property is accessed for the first time, THE SqlxContext SHALL resolve it from IServiceProvider and cache the instance
3. WHEN a repository property is accessed multiple times, THE SqlxContext SHALL return the same cached instance
4. THE SqlxContext SHALL set the DbConnection on resolved repositories via ISqlxRepository interface
5. THE SqlxContext SHALL set the current DbTransaction on resolved repositories when a transaction is active

### Requirement 3: Transaction Management

**User Story:** As a developer, I want to manage transactions through the context, so that I can ensure all repository operations participate in the same transaction.

#### Acceptance Criteria

1. THE SqlxContext SHALL provide a BeginTransactionAsync() method that returns a DbTransaction
2. THE SqlxContext SHALL provide a BeginTransaction() method for synchronous scenarios
3. THE SqlxContext SHALL provide a UseTransaction() method to accept external transactions
4. WHEN a transaction is active, THE SqlxContext SHALL automatically set the Transaction property on all repositories
5. WHEN a transaction is committed or rolled back, THE SqlxContext SHALL clear the Transaction property on all repositories
6. THE SqlxContext SHALL support nested transaction scopes through SavePoint functionality
7. THE SqlxContext SHALL throw an exception if BeginTransaction is called when a transaction is already active
8. THE SqlxContext SHALL track whether it owns a transaction or is using an external transaction
9. WHEN disposing, THE SqlxContext SHALL only rollback and dispose transactions it owns
10. THE SqlxContext SHALL throw an exception if UseTransaction is called when an owned transaction is active

### Requirement 4: Connection Lifecycle Management

**User Story:** As a developer, I want the context to manage connection disposal, so that I don't need to manually close connections and can ensure proper cleanup.

#### Acceptance Criteria

1. THE SqlxContext SHALL implement IDisposable for proper resource cleanup
2. THE SqlxContext SHALL implement IAsyncDisposable for async resource cleanup
3. WHEN Dispose is called, THE SqlxContext SHALL dispose the DbConnection if it owns the connection
4. WHEN Dispose is called, THE SqlxContext SHALL rollback any active transaction
5. THE SqlxContext SHALL support both owned and external connections
6. WHERE an external connection is provided, THE SqlxContext SHALL NOT dispose the connection

### Requirement 5: Source Generator Integration

**User Story:** As a developer, I want to explicitly specify which repositories to include in my context, so that I have full control over context composition.

#### Acceptance Criteria

1. THE Source_Generator SHALL detect classes marked with [SqlxContext] attribute
2. THE Source_Generator SHALL read [IncludeRepository(typeof(RepositoryType))] attributes from the context class
3. THE Source_Generator SHALL extract entity type from each repository's [RepositoryFor] interface
4. THE Source_Generator SHALL generate a DI-friendly constructor accepting DbConnection and all repositories if not provided by user
5. THE Source_Generator SHALL generate readonly backing fields for injected repositories
6. THE Source_Generator SHALL generate properties that return the injected repositories
7. THE Source_Generator SHALL generate PropagateTransactionToRepositories() and ClearRepositoryTransactions() overrides
8. THE Source_Generator SHALL respect the database dialect specified in [SqlDefine] attribute on the context
9. THE Source_Generator SHALL support multiple contexts with different repository sets

### Requirement 6: Performance and AOT Compatibility

**User Story:** As a developer, I want the context to maintain Sqlx's performance characteristics, so that I don't sacrifice speed for convenience.

#### Acceptance Criteria

1. THE SqlxContext SHALL use zero reflection at runtime
2. THE SqlxContext SHALL be fully compatible with Native AOT compilation
3. THE SqlxContext SHALL use compile-time code generation for repository instantiation
4. THE SqlxContext SHALL cache repository instances to avoid repeated instantiation
5. THE SqlxContext SHALL have minimal memory overhead compared to manual repository management

### Requirement 7: Dependency Injection Support

**User Story:** As a developer, I want to register the context with DI containers using extension methods, so that I have a convenient way to configure contexts in ASP.NET Core applications.

#### Acceptance Criteria

1. THE SqlxContext SHALL provide extension methods for IServiceCollection registration
2. THE extension methods SHALL support scoped and transient lifetimes
3. THE extension methods SHALL support factory-based registration
4. THE extension methods SHALL NOT require source generator support
5. THE SqlxContext SHALL work with connection pooling in ASP.NET Core

### Requirement 8: Error Handling and Diagnostics

**User Story:** As a developer, I want clear error messages when something goes wrong, so that I can quickly diagnose and fix issues.

#### Acceptance Criteria

1. WHEN a repository is not accessible, THE SqlxContext SHALL provide clear compile-time errors
2. WHEN a transaction operation fails, THE SqlxContext SHALL throw the original exception with context information
3. WHEN Dispose is called multiple times, THE SqlxContext SHALL handle it gracefully without throwing
4. THE SqlxContext SHALL log transaction begin/commit/rollback events if a logger is provided
5. THE SqlxContext SHALL provide a property to check if a transaction is currently active

### Requirement 8: Backward Compatibility

**User Story:** As an existing Sqlx user, I want the context feature to be optional, so that I can continue using repositories directly if I prefer.

#### Acceptance Criteria

1. THE SqlxContext SHALL be an optional feature that does not affect existing code
2. THE SqlxContext SHALL NOT require changes to existing repository interfaces or implementations
3. THE SqlxContext SHALL work alongside manual repository instantiation
4. THE SqlxContext SHALL NOT introduce breaking changes to the Sqlx API
5. THE SqlxContext SHALL be opt-in through the [SqlxContext] attribute

### Requirement 9: Documentation and Examples

**User Story:** As a developer, I want clear documentation and examples, so that I can quickly learn how to use the context feature.

#### Acceptance Criteria

1. THE Documentation SHALL include a getting started guide for SqlxContext
2. THE Documentation SHALL include examples of manual and source-generated contexts
3. THE Documentation SHALL include examples of transaction management
4. THE Documentation SHALL include examples of DI registration in ASP.NET Core
5. THE Documentation SHALL explain when to use SqlxContext vs manual repository management
