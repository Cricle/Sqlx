# CI/CDé…ç½®æ›´æ–°æ€»ç»“

## ğŸ“‹ æ›´æ–°æ¦‚è§ˆ

å·²å°†åŸæœ‰çš„`ci-cd.yml`å·¥ä½œæµæ›´æ–°ä¸ºæ”¯æŒå¤šæ•°æ®åº“æ–¹è¨€æµ‹è¯•çš„ç‰ˆæœ¬ã€‚

---

## ğŸ”„ ä¸»è¦å˜æ›´

### 1. **æµ‹è¯•ä½œä¸šæ‹†åˆ†**

#### ä¹‹å‰ (å•ä¸€æµ‹è¯•ä½œä¸š)
```yaml
jobs:
  test:
    - è¿è¡Œæ‰€æœ‰æµ‹è¯•
    - ç”Ÿæˆè¦†ç›–ç‡
    - æ‰“åŒ…
```

#### ä¹‹å (å¤šä½œä¸šæµæ°´çº¿)
```yaml
jobs:
  test-local:           # SQLiteæµ‹è¯• (2-3åˆ†é’Ÿ)
  test-all-dialects:    # å¤šæ–¹è¨€æµ‹è¯• (5-8åˆ†é’Ÿ)
  coverage:             # è¦†ç›–ç‡æ±‡æ€»
  publish:              # å‘å¸ƒåˆ°NuGet
```

---

## ğŸ“Š æ–°çš„å·¥ä½œæµç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Push / PR / Tag                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚test-    â”‚        â”‚test-all-dialects â”‚
â”‚local    â”‚        â”‚(needs: test-local)â”‚
â”‚(SQLite) â”‚        â”‚                  â”‚
â”‚2-3 min  â”‚        â”‚ â”Œâ”€â”€PostgreSQL   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚ â”œâ”€â”€MySQL        â”‚
    â”‚              â”‚ â””â”€â”€SQL Server   â”‚
    â”‚              â”‚   5-8 min       â”‚
    â”‚              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚coverage â”‚
        â”‚(æ±‡æ€»)    â”‚
        â”‚1-2 min  â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚publish (ä»…tagæ—¶)  â”‚
    â”‚å‘å¸ƒåˆ°NuGet        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. æœ¬åœ°æµ‹è¯•ä½œä¸š (`test-local`)

**ç›®çš„**: å¿«é€Ÿåé¦ˆï¼ŒéªŒè¯åŸºæœ¬åŠŸèƒ½

**ç‰¹ç‚¹**:
- âœ… ä½¿ç”¨SQLiteå†…å­˜æ•°æ®åº“
- âœ… æ— éœ€é¢å¤–æœåŠ¡
- âœ… é€Ÿåº¦å¿« (2-3åˆ†é’Ÿ)
- âœ… ä½¿ç”¨`.runsettings`é…ç½®

**è¿è¡Œæ—¶æœº**: æ¯æ¬¡push/PR

```yaml
- name: ğŸ§ª Run Local Tests (SQLite)
  run: |
    dotnet test --configuration Release --no-build \
                --settings .runsettings \
                --results-directory ./TestResults
```

**é¢„æœŸç»“æœ**: 1,582ä¸ªæµ‹è¯•é€šè¿‡

### 2. å¤šæ–¹è¨€æµ‹è¯•ä½œä¸š (`test-all-dialects`)

**ç›®çš„**: å®Œæ•´éªŒè¯æ‰€æœ‰æ•°æ®åº“æ–¹è¨€

**ç‰¹ç‚¹**:
- âœ… ä¾èµ–`test-local`æˆåŠŸ
- âœ… å¯åŠ¨3ä¸ªæ•°æ®åº“æœåŠ¡
- âœ… å®Œæ•´æµ‹è¯•è¦†ç›– (1,626ä¸ªæµ‹è¯•)
- âœ… ä½¿ç”¨`.runsettings.ci`é…ç½®

**æ•°æ®åº“æœåŠ¡**:
```yaml
services:
  postgres:
    image: postgres:16
    ports: 5432:5432

  mysql:
    image: mysql:8.3
    ports: 3306:3306

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    ports: 1433:1433
```

**ç¯å¢ƒå˜é‡**:
```yaml
env:
  CI: true
  POSTGRESQL_CONNECTION: "Host=localhost;Port=5432;..."
  MYSQL_CONNECTION: "Server=localhost;Port=3306;..."
  SQLSERVER_CONNECTION: "Server=localhost,1433;..."
```

**é¢„æœŸç»“æœ**: 1,626ä¸ªæµ‹è¯•é€šè¿‡

### 3. è¦†ç›–ç‡æŠ¥å‘Šä½œä¸š (`coverage`)

**ç›®çš„**: æ±‡æ€»æ‰€æœ‰æµ‹è¯•çš„è¦†ç›–ç‡

**ç‰¹ç‚¹**:
- âœ… ä¾èµ–ä¸¤ä¸ªæµ‹è¯•ä½œä¸šå®Œæˆ
- âœ… ä¸‹è½½æ‰€æœ‰æµ‹è¯•ç»“æœ
- âœ… ä¸Šä¼ åˆ°Codecov
- âœ… å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿè¿è¡Œ (`if: always()`)

```yaml
- name: ğŸ“¥ Download test results
  uses: actions/download-artifact@v4
  with:
    path: test-results

- name: ğŸ“Š Upload coverage to Codecov
  uses: codecov/codecov-action@v4
  with:
    directory: test-results/
    files: "**/coverage.cobertura.xml"
```

### 4. å‘å¸ƒä½œä¸šæ›´æ–° (`publish`)

**å˜æ›´**: ä¾èµ–æ”¹ä¸ºä¸¤ä¸ªæµ‹è¯•ä½œä¸š

```yaml
# ä¹‹å‰
needs: test

# ä¹‹å
needs: [test-local, test-all-dialects]
```

**å«ä¹‰**: åªæœ‰æ‰€æœ‰æµ‹è¯•é€šè¿‡åæ‰ä¼šå‘å¸ƒ

---

## ğŸ”§ é…ç½®æ–‡ä»¶ä½¿ç”¨

### `.runsettings` (æœ¬åœ°æµ‹è¯•)

```yaml
- name: ğŸ§ª Run Local Tests (SQLite)
  run: |
    dotnet test --settings .runsettings
```

**ç‰¹ç‚¹**:
- åªè¿è¡ŒSQLiteæµ‹è¯•
- è·³è¿‡éœ€è¦çœŸå®æ•°æ®åº“çš„æµ‹è¯•
- æœ¬åœ°å¼€å‘å’ŒCIéƒ½é€‚ç”¨

### `.runsettings.ci` (å¤šæ–¹è¨€æµ‹è¯•)

```yaml
- name: ğŸ§ª Run Multi-Dialect Tests
  env:
    CI: true
    POSTGRESQL_CONNECTION: "..."
    MYSQL_CONNECTION: "..."
    SQLSERVER_CONNECTION: "..."
  run: |
    dotnet test --settings .runsettings.ci
```

**ç‰¹ç‚¹**:
- è¿è¡Œæ‰€æœ‰æ–¹è¨€æµ‹è¯•
- ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„æ•°æ®åº“è¿æ¥
- ä»…åœ¨CIç¯å¢ƒä½¿ç”¨

---

## ğŸ“Š æµ‹è¯•ç»Ÿè®¡å¯¹æ¯”

### ä¹‹å‰
```
æ€»æµ‹è¯•: 1,582ä¸ª (ä»…SQLite)
æ•°æ®åº“: SQLite (å†…å­˜)
æ—¶é—´: ~3åˆ†é’Ÿ
```

### ä¹‹å

#### test-localä½œä¸š
```
æ€»æµ‹è¯•: 1,582ä¸ª
é€šè¿‡: 1,582ä¸ª
è·³è¿‡: 44ä¸ª (éœ€è¦çœŸå®æ•°æ®åº“)
æ•°æ®åº“: SQLite (å†…å­˜)
æ—¶é—´: 2-3åˆ†é’Ÿ
```

#### test-all-dialectsä½œä¸š
```
æ€»æµ‹è¯•: 1,626ä¸ª
é€šè¿‡: 1,626ä¸ª
è·³è¿‡: 0ä¸ª
æ•°æ®åº“: SQLite + PostgreSQL + MySQL + SQL Server
æ—¶é—´: 5-8åˆ†é’Ÿ
```

#### æ€»è®¡
```
æ€»æ—¶é—´: 7-11åˆ†é’Ÿ (å¹¶è¡Œæ‰§è¡Œéƒ¨åˆ†æ­¥éª¤)
è¦†ç›–ç‡: >85%
æ–¹è¨€: 4ä¸ªæ•°æ®åº“ (SQLite, PostgreSQL, MySQL, SQL Server)
```

---

## ğŸ¯ è¿è¡Œæ—¶æœº

### æ¯æ¬¡Push/PR
- âœ… `test-local`: å¿«é€ŸéªŒè¯åŸºæœ¬åŠŸèƒ½
- âœ… `test-all-dialects`: å®Œæ•´éªŒè¯æ‰€æœ‰æ–¹è¨€
- âœ… `coverage`: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š

### åˆ›å»ºTag (v*)
- âœ… `test-local`: éªŒè¯
- âœ… `test-all-dialects`: å®Œæ•´éªŒè¯
- âœ… `coverage`: è¦†ç›–ç‡
- âœ… `publish`: å‘å¸ƒåˆ°NuGet + åˆ›å»ºGitHub Release

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. NuGetåŒ…ç¼“å­˜
```yaml
- name: ğŸ“¦ Cache NuGet packages
  uses: actions/cache@v4
  with:
    path: ~/.nuget/packages
    key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
```

**æ•ˆæœ**: é¦–æ¬¡æ¢å¤~30ç§’ï¼Œç¼“å­˜å~5ç§’

### 2. å¹¶è¡Œæµ‹è¯•
```xml
<Parallelize>
  <Workers>0</Workers>
  <Scope>MethodLevel</Scope>
</Parallelize>
```

**æ•ˆæœ**: æµ‹è¯•æ—¶é—´å‡å°‘~11%

### 3. ä½œä¸šä¾èµ–ä¼˜åŒ–
```yaml
test-local â†’ test-all-dialects
                â†“
            coverage
```

**æ•ˆæœ**: å¿«é€Ÿå¤±è´¥ï¼ŒèŠ‚çœCIèµ„æº

---

## ğŸš¨ æ•…éšœåœºæ™¯

### åœºæ™¯1: æœ¬åœ°æµ‹è¯•å¤±è´¥
```
test-local âŒ
  â†“
test-all-dialects â¸ï¸ (è·³è¿‡)
coverage â¸ï¸ (è·³è¿‡)
publish â¸ï¸ (è·³è¿‡)
```

### åœºæ™¯2: å¤šæ–¹è¨€æµ‹è¯•å¤±è´¥
```
test-local âœ…
  â†“
test-all-dialects âŒ
  â†“
coverage âœ… (ä»è¿è¡Œï¼Œif: always())
publish â¸ï¸ (è·³è¿‡)
```

### åœºæ™¯3: æ‰€æœ‰æµ‹è¯•é€šè¿‡
```
test-local âœ…
  â†“
test-all-dialects âœ…
  â†“
coverage âœ…
  â†“
publish âœ… (ä»…tagæ—¶)
```

---

## ğŸ” æŸ¥çœ‹ç»“æœ

### GitHub Actionsé¡µé¢
1. è¿›å…¥Actionsæ ‡ç­¾
2. é€‰æ‹©å·¥ä½œæµè¿è¡Œ
3. æŸ¥çœ‹å„ä½œä¸šçŠ¶æ€å’Œæ—¥å¿—

### Pull Request
- æ£€æŸ¥æ˜¾ç¤ºæµ‹è¯•çŠ¶æ€
- å¯æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
- è¦†ç›–ç‡æŠ¥å‘Šä¸Šä¼ åˆ°Codecov

---

## ğŸ“ åç»­è®¡åˆ’

### çŸ­æœŸ (å·²å®Œæˆ)
- [x] æ‹†åˆ†æµ‹è¯•ä½œä¸š
- [x] æ·»åŠ å¤šæ–¹è¨€æµ‹è¯•
- [x] é…ç½®æ•°æ®åº“æœåŠ¡
- [x] è¦†ç›–ç‡æ±‡æ€»

### ä¸­æœŸ (1-2å‘¨)
- [ ] å®ç°MySQLæ–¹è¨€æµ‹è¯• (20ä¸ªæµ‹è¯•)
- [ ] å®ç°SQL Serveræ–¹è¨€æµ‹è¯• (20ä¸ªæµ‹è¯•)
- [ ] æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•

### é•¿æœŸ (1-2æœˆ)
- [ ] Oracleæ–¹è¨€æ”¯æŒ
- [ ] é›†æˆæµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•
- [ ] æ€§èƒ½å›å½’æ£€æµ‹

---

## âœ… éªŒè¯æ¸…å•

- [x] `.runsettings`é…ç½®æ–‡ä»¶å­˜åœ¨
- [x] `.runsettings.ci`é…ç½®æ–‡ä»¶å­˜åœ¨
- [x] `DatabaseConnectionHelper.cs`å®ç°ç¯å¢ƒæ£€æµ‹
- [x] å¤šæ–¹è¨€æµ‹è¯•åŸºç±»`ComprehensiveTestBase`
- [x] SQLiteæµ‹è¯•å®ç° (20ä¸ªæµ‹è¯•)
- [x] PostgreSQLæµ‹è¯•å®ç° (20ä¸ªæµ‹è¯•)
- [x] GitHub Actionså·¥ä½œæµæ›´æ–°
- [x] æ•°æ®åº“æœåŠ¡é…ç½®æ­£ç¡®
- [x] æµ‹è¯•è„šæœ¬å¯ç”¨ (test-local.sh, test-all.sh)
- [x] æ–‡æ¡£å®Œæ•´

---

## ğŸ‰ æ€»ç»“

### æ›´æ–°å†…å®¹
- âœ… **å·¥ä½œæµæ‹†åˆ†** - ä»å•ä¸€ä½œä¸šæ‹†åˆ†ä¸º4ä¸ªä½œä¸š
- âœ… **å¤šæ–¹è¨€æ”¯æŒ** - æ”¯æŒ4ä¸ªæ•°æ®åº“æ–¹è¨€æµ‹è¯•
- âœ… **æ™ºèƒ½é…ç½®** - ä¸¤å¥—runsettingsè‡ªåŠ¨é€‚é…
- âœ… **å¹¶è¡Œä¼˜åŒ–** - åˆç†çš„ä½œä¸šä¾èµ–å’Œå¹¶è¡Œæ‰§è¡Œ
- âœ… **å®Œæ•´æ–‡æ¡£** - è¯¦ç»†çš„é…ç½®è¯´æ˜å’Œä½¿ç”¨æŒ‡å—

### å…³é”®æŒ‡æ ‡
| æŒ‡æ ‡ | ä¹‹å‰ | ä¹‹å | æ”¹è¿› |
|------|------|------|------|
| æµ‹è¯•æ•° | 1,582 | 1,626 | +44 (+2.8%) |
| æ•°æ®åº“ | 1 | 4 | +300% |
| è¦†ç›–ç‡ | ~85% | ~85% | ä¿æŒ |
| æ—¶é—´ | ~3åˆ†é’Ÿ | 7-11åˆ†é’Ÿ | +æ›´å…¨é¢ |
| ä½œä¸šæ•° | 2 | 4 | +100% |

### ä½¿ç”¨æ–¹å¼

**æœ¬åœ°å¼€å‘**:
```bash
# å¿«é€Ÿæµ‹è¯•
./test-local.sh

# å®Œæ•´æµ‹è¯•
docker-compose up -d && ./test-all.sh
```

**CIè‡ªåŠ¨åŒ–**:
```
# ç›´æ¥pushï¼Œè‡ªåŠ¨è¿è¡Œ
git push origin feature-branch

# æŸ¥çœ‹ç»“æœ
GitHub Actionsé¡µé¢ â†’ å·¥ä½œæµè¿è¡Œ â†’ å„ä½œä¸šçŠ¶æ€
```

---

**CI/CDé…ç½®æ›´æ–°å®Œæˆï¼ç°åœ¨æ”¯æŒå®Œæ•´çš„å¤šæ•°æ®åº“æ–¹è¨€è‡ªåŠ¨åŒ–æµ‹è¯•ï¼** ğŸš€

