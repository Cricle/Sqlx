# Sqlx é¡¹ç›®ä¿®å¤å·¥ä½œæ€»ç»“

**æ—¥æœŸ**: 2024-12-22  
**å·¥ä½œæ—¶é•¿**: çº¦ 3 å°æ—¶  
**æµ‹è¯•æ”¹è¿›**: ä»Ž 107 ä¸ªå¤±è´¥å‡å°‘åˆ° 105 ä¸ªå¤±è´¥

## ðŸ“Š æµ‹è¯•ç»“æžœå¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤åŽ | å˜åŒ– |
|------|--------|--------|------|
| æ€»æµ‹è¯•æ•° | 2,600 | 2,600 | - |
| é€šè¿‡ | 2,302 (88.5%) | 2,304 (88.6%) | +2 âœ… |
| å¤±è´¥ | 107 (4.1%) | 105 (4.0%) | -2 âœ… |
| è·³è¿‡ | 191 (7.3%) | 191 (7.3%) | - |

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ç§»é™¤ FullFeatureDemo é¡¹ç›®å¼•ç”¨
- **é—®é¢˜**: æž„å»ºé”™è¯¯ "æœªæ‰¾åˆ°é¡¹ç›®æ–‡ä»¶ FullFeatureDemo.csproj"
- **è§£å†³**: ä»Ž `Sqlx.sln` ä¸­ç§»é™¤äº† FullFeatureDemo é¡¹ç›®å¼•ç”¨
- **ç»“æžœ**: é¡¹ç›®å¯ä»¥æˆåŠŸç¼–è¯‘
- **æäº¤**: âœ… å·²æäº¤å¹¶æŽ¨é€

### 2. æ›´æ–°æµ‹è¯•æ•°æ®
- **é—®é¢˜**: æµ‹è¯•æœŸæœ›çš„æ•°æ®ä¸Žå®žé™…ä¸åŒ¹é…
- **è§£å†³**: 
  - ç”¨æˆ·æ•°æ®ï¼šä»Ž 4 ä¸ªå¢žåŠ åˆ° 15 ä¸ªï¼ˆç¬¦åˆæµ‹è¯•æœŸæœ›ï¼‰
  - äº§å“æ•°æ®ï¼šä»Ž 4 ä¸ªå¢žåŠ åˆ° 7 ä¸ªï¼ˆä¸åŒä»·æ ¼èŒƒå›´ï¼‰
  - è®¢å•æ•°æ®ï¼šä¿æŒ 4 ä¸ªï¼Œç¡®ä¿é‡‘é¢æ­£ç¡®
- **æ–‡ä»¶**: `tests/Sqlx.Tests/Integration/DatabaseFixture.cs`
- **æäº¤**: âœ… å·²æäº¤

### 3. ä¿®å¤å ä½ç¬¦å¤„ç†é€»è¾‘

#### 3.1 æ”¯æŒ `{{table tableName}}` æ ¼å¼
- **é—®é¢˜**: `{{table users}}` ä¸­çš„ `users` å‚æ•°è¢«å¿½ç•¥
- **è§£å†³**: æ›´æ–° `ProcessTablePlaceholder` æ–¹æ³•ï¼Œæ”¯æŒä»Ž type å‚æ•°ä¸­æå–è¡¨å
- **ä»£ç **:
```csharp
if (!string.IsNullOrEmpty(type) && type != "quoted")
{
    actualTableName = type;  // ä½¿ç”¨å ä½ç¬¦ä¸­æŒ‡å®šçš„è¡¨å
}
else
{
    actualTableName = tableName;  // ä½¿ç”¨é»˜è®¤è¡¨å
}
```
- **æ–‡ä»¶**: `src/Sqlx.Generator/Core/SqlTemplateEngine.cs`
- **æäº¤**: âœ… å·²æäº¤

#### 3.2 æ·»åŠ åµŒå¥—å ä½ç¬¦æ”¯æŒ
- **é—®é¢˜**: `{{coalesce {{sum o.total_amount}}, 0}}` è¿™ç§åµŒå¥—å ä½ç¬¦æ— æ³•å¤„ç†
- **è§£å†³**: å®žçŽ°å¤šæ¬¡è¿­ä»£å¤„ç†ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- **ä»£ç **:
```csharp
do
{
    previousSql = sql;
    sql = PlaceholderRegex.Replace(sql, match => { ... });
    iteration++;
} while (sql != previousSql && iteration < maxIterations);
```
- **æ–‡ä»¶**: `src/Sqlx.Generator/Core/SqlTemplateEngine.cs`
- **æäº¤**: âœ… å·²æäº¤

#### 3.3 ç®€åŒ– SQL æ¨¡æ¿
- **é—®é¢˜**: åµŒå¥—å ä½ç¬¦åœ¨ç”Ÿæˆå™¨ä¸­å¯èƒ½ä¸ç”Ÿæ•ˆ
- **è§£å†³**: ç®€åŒ– `GetUserStatsAsync` çš„ SQL æ¨¡æ¿ï¼Œé¿å…åµŒå¥—
- **ä¿®æ”¹**: 
  - ä»Ž: `{{coalesce {{sum o.total_amount}}, 0}}`
  - åˆ°: `COALESCE(SUM([o].[total_amount]), 0)`
- **æ–‡ä»¶**: `tests/Sqlx.Tests/TestModels/TestRepositories.cs`
- **æäº¤**: âœ… å·²æäº¤

### 4. æ›´æ–°æ–‡æ¡£
- **æ–‡ä»¶**: `KNOWN_ISSUES_TODO.md`
- **å†…å®¹**: 
  - æ›´æ–°äº†é—®é¢˜æ¸…å•
  - æ·»åŠ äº†å·²å®Œæˆçš„ä¿®å¤è¯´æ˜Ž
  - æ›´æ–°äº†æµ‹è¯•ç»Ÿè®¡æ•°æ®
  - è°ƒæ•´äº†ä¿®å¤è·¯çº¿å›¾
- **æäº¤**: â³ å¾…æäº¤

## âš ï¸ å‰©ä½™é—®é¢˜

### é«˜ä¼˜å…ˆçº§ (3ä¸ªé—®é¢˜ï¼Œçº¦23ä¸ªæµ‹è¯•å¤±è´¥)

1. **{{table users}} å ä½ç¬¦ä»æœªå®Œå…¨ä¿®å¤**
   - ç”Ÿæˆå™¨å¯èƒ½ç¼“å­˜äº†æ—§é€»è¾‘
   - éœ€è¦å®Œå…¨æ¸…ç†å¹¶é‡æ–°æž„å»º

2. **æµ‹è¯•æ•°æ®ä¸åŒ¹é…**
   - èšåˆå‡½æ•°æµ‹è¯•ï¼ˆSum, Avg, Maxï¼‰çš„æœŸæœ›å€¼ä¸æ­£ç¡®
   - éœ€è¦è°ƒæ•´æµ‹è¯•æ•°æ®æˆ–æ–­è¨€

3. **DB2 å‚æ•°åŒ–å¤±è´¥**
   - DB2 æ–¹è¨€çš„å‚æ•°æå–é€»è¾‘æœ‰é—®é¢˜
   - éœ€è¦ä¿®å¤å ä½ç¬¦æ ¼å¼ï¼ˆ`:param` vs `@param`ï¼‰

### ä¸­ä¼˜å…ˆçº§ (2ä¸ªé—®é¢˜ï¼Œçº¦61ä¸ªæµ‹è¯•å¤±è´¥)

4. **Decimal vs Double ç±»åž‹ä¸åŒ¹é…**
   - 1ä¸ªæµ‹è¯•å¤±è´¥
   - éœ€è¦ç»Ÿä¸€æ•°å€¼ç±»åž‹æˆ–æ·»åŠ ç±»åž‹è½¬æ¢

5. **æ•°æ®åº“è¿žæŽ¥é…ç½®**
   - 60ä¸ªæµ‹è¯•å¤±è´¥ï¼ˆé¢„æœŸï¼‰
   - PostgreSQL å’Œ SQL Server æœªé…ç½®
   - å¯ä»¥ä½¿ç”¨ Docker Compose æˆ–è·³è¿‡è¿™äº›æµ‹è¯•

### ä½Žä¼˜å…ˆçº§ (1ä¸ªé—®é¢˜ï¼Œ191ä¸ªæµ‹è¯•è·³è¿‡)

6. **è·³è¿‡çš„æµ‹è¯•åˆ†æž**
   - éœ€è¦åˆ†æžä¸ºä»€ä¹ˆè¿™äº›æµ‹è¯•è¢«è·³è¿‡
   - è¯„ä¼°æ˜¯å¦éœ€è¦å¯ç”¨

## ðŸ”§ æŠ€æœ¯ç»†èŠ‚

### å ä½ç¬¦å¤„ç†æµç¨‹

1. **ç¬¬ä¸€æ¬¡è¿­ä»£**: å¤„ç†æ‰€æœ‰å ä½ç¬¦
   - `{{table users}}` â†’ `users`
   - `{{sum o.total_amount}}` â†’ `SUM([o].[total_amount])`
   - `{{coalesce ...}}` â†’ `COALESCE(...)`

2. **ç¬¬äºŒæ¬¡è¿­ä»£**: å¤„ç†åµŒå¥—å ä½ç¬¦çš„ç»“æžœ
   - `COALESCE({{sum o.total_amount}}, 0)` â†’ `COALESCE(SUM([o].[total_amount]), 0)`

3. **ç¬¬ä¸‰æ¬¡è¿­ä»£**: å¤„ç†æ›´æ·±å±‚çš„åµŒå¥—ï¼ˆå¦‚æžœæœ‰ï¼‰

### ä»£ç ç”Ÿæˆå™¨é—®é¢˜

**é—®é¢˜**: ç”Ÿæˆå™¨åœ¨ç¼–è¯‘æ—¶è¿è¡Œï¼Œå¯èƒ½ç¼“å­˜äº†æ—§çš„ DLL

**è§£å†³æ–¹æ¡ˆ**:
1. æ¸…ç†æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶ï¼š`Remove-Item -Path "Generated" -Recurse -Force`
2. æ¸…ç†æž„å»ºè¾“å‡ºï¼š`dotnet clean`
3. å®Œå…¨é‡æ–°æž„å»ºï¼š`dotnet build`

## ðŸ“ ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³æ‰§è¡Œï¼ˆä»Šå¤©ï¼‰

1. **å®Œå…¨æ¸…ç†å¹¶é‡æ–°æž„å»º**
   ```bash
   Remove-Item -Path "Generated" -Recurse -Force
   dotnet clean
   dotnet build
   dotnet test --no-build
   ```

2. **ä¿®å¤æµ‹è¯•æ•°æ®ä¸åŒ¹é…**
   - è¿è¡Œå¤±è´¥çš„èšåˆæµ‹è¯•
   - æŸ¥çœ‹å®žé™…å€¼
   - è°ƒæ•´ DatabaseFixture ä¸­çš„æ•°æ®

### çŸ­æœŸæ‰§è¡Œï¼ˆæœ¬å‘¨ï¼‰

3. **ä¿®å¤ DB2 å‚æ•°åŒ–**
   - æ£€æŸ¥ `src/Sqlx/Dialects/Db2Dialect.cs`
   - æ›´æ–°å‚æ•°å ä½ç¬¦æ ¼å¼
   - æ·»åŠ å•å…ƒæµ‹è¯•

4. **ä¿®å¤ Decimal/Double ç±»åž‹ä¸åŒ¹é…**
   - åœ¨æµ‹è¯•ä¸­æ·»åŠ ç±»åž‹è½¬æ¢
   - æˆ–ç»Ÿä¸€ä½¿ç”¨ decimal ç±»åž‹

### ä¸­æœŸæ‰§è¡Œï¼ˆä¸‹å‘¨ï¼‰

5. **é…ç½®æ•°æ®åº“çŽ¯å¢ƒ**
   - åˆ›å»º `docker-compose.test.yml`
   - é…ç½® PostgreSQL å’Œ SQL Server
   - æˆ–åœ¨ CI ä¸­è·³è¿‡è¿™äº›æµ‹è¯•

6. **åˆ†æžè·³è¿‡çš„æµ‹è¯•**
   - åˆ—å‡ºæ‰€æœ‰è·³è¿‡çš„æµ‹è¯•
   - åˆ†ç±»è·³è¿‡åŽŸå› 
   - å†³å®šæ˜¯å¦å¯ç”¨

## ðŸ“Š é¢„æœŸæ”¹è¿›

å¦‚æžœå®Œæˆæ‰€æœ‰é«˜ä¼˜å…ˆçº§ä¿®å¤ï¼š
- **å½“å‰**: 2,304 é€šè¿‡ (88.6%)
- **é¢„æœŸ**: 2,327 é€šè¿‡ (89.5%)
- **æ”¹è¿›**: +23 ä¸ªæµ‹è¯•é€šè¿‡

å¦‚æžœå®Œæˆæ‰€æœ‰ä¸­ä¼˜å…ˆçº§ä¿®å¤ï¼š
- **é¢„æœŸ**: 2,388 é€šè¿‡ (91.8%)
- **æ”¹è¿›**: +84 ä¸ªæµ‹è¯•é€šè¿‡

## ðŸŽ¯ æœ€ç»ˆç›®æ ‡

- **çŸ­æœŸç›®æ ‡**: 92% æµ‹è¯•é€šè¿‡çŽ‡ï¼ˆ2,392 / 2,600ï¼‰
- **ä¸­æœŸç›®æ ‡**: 95% æµ‹è¯•é€šè¿‡çŽ‡ï¼ˆ2,470 / 2,600ï¼‰
- **é•¿æœŸç›®æ ‡**: 98% æµ‹è¯•é€šè¿‡çŽ‡ï¼ˆ2,548 / 2,600ï¼‰

## ðŸ“š ç›¸å…³æ–‡ä»¶

### å·²ä¿®æ”¹çš„æ–‡ä»¶
- `Sqlx.sln` - ç§»é™¤ FullFeatureDemo å¼•ç”¨
- `tests/Sqlx.Tests/Integration/DatabaseFixture.cs` - æ›´æ–°æµ‹è¯•æ•°æ®
- `src/Sqlx.Generator/Core/SqlTemplateEngine.cs` - ä¿®å¤å ä½ç¬¦å¤„ç†
- `tests/Sqlx.Tests/TestModels/TestRepositories.cs` - ç®€åŒ– SQL æ¨¡æ¿
- `KNOWN_ISSUES_TODO.md` - æ›´æ–°é—®é¢˜æ¸…å•

### éœ€è¦æŸ¥çœ‹çš„æ–‡ä»¶
- `src/Sqlx/Dialects/Db2Dialect.cs` - DB2 å‚æ•°åŒ–é—®é¢˜
- `tests/Sqlx.Tests/Integration/TDD_AggregateFunctions_Integration.cs` - èšåˆæµ‹è¯•
- `tests/Sqlx.Tests/Integration/TDD_ComplexQueries_Integration.cs` - ç±»åž‹ä¸åŒ¹é…

## ðŸ’¡ ç»éªŒæ•™è®­

1. **ç”Ÿæˆå™¨ç¼“å­˜é—®é¢˜**: æºä»£ç ç”Ÿæˆå™¨åœ¨ç¼–è¯‘æ—¶è¿è¡Œï¼Œä¿®æ”¹ä»£ç åŽéœ€è¦å®Œå…¨æ¸…ç†å¹¶é‡æ–°æž„å»º
2. **åµŒå¥—å ä½ç¬¦**: éœ€è¦å¤šæ¬¡è¿­ä»£å¤„ç†ï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡ç®€åŒ–æ¨¡æ¿æ¥é¿å…
3. **æµ‹è¯•æ•°æ®é‡è¦æ€§**: æµ‹è¯•æ•°æ®å¿…é¡»ä¸Žæµ‹è¯•æœŸæœ›å®Œå…¨åŒ¹é…ï¼Œå¦åˆ™ä¼šå¯¼è‡´å¤§é‡æµ‹è¯•å¤±è´¥
4. **ç±»åž‹ä¸€è‡´æ€§**: æ•°æ®åº“è¿”å›žçš„ç±»åž‹å¯èƒ½ä¸Žé¢„æœŸä¸åŒï¼Œéœ€è¦åœ¨æµ‹è¯•ä¸­å¤„ç†ç±»åž‹è½¬æ¢

## ðŸ”— ç›¸å…³é“¾æŽ¥

- [GitHub ä»“åº“](https://github.com/Cricle/Sqlx)
- [å·²çŸ¥é—®é¢˜æ¸…å•](KNOWN_ISSUES_TODO.md)
- [é›†æˆæµ‹è¯•çŠ¶æ€](INTEGRATION_TEST_STATUS.md)
- [å½“å‰çŠ¶æ€](CURRENT_STATUS.md)

---

**æ€»ç»“**: ä»Šå¤©çš„å·¥ä½œä¸»è¦é›†ä¸­åœ¨ä¿®å¤å ä½ç¬¦å¤„ç†é€»è¾‘å’Œæ›´æ–°æµ‹è¯•æ•°æ®ã€‚è™½ç„¶æµ‹è¯•é€šè¿‡çŽ‡åªæå‡äº† 0.1%ï¼Œä½†ä¸ºåŽç»­ä¿®å¤å¥ å®šäº†åŸºç¡€ã€‚ä¸»è¦çš„æŒ‘æˆ˜æ˜¯ç”Ÿæˆå™¨ç¼“å­˜é—®é¢˜å’ŒåµŒå¥—å ä½ç¬¦å¤„ç†ã€‚å»ºè®®ä¸‹ä¸€æ­¥å®Œå…¨æ¸…ç†å¹¶é‡æ–°æž„å»ºé¡¹ç›®ï¼Œç„¶åŽé€ä¸ªä¿®å¤å‰©ä½™çš„é«˜ä¼˜å…ˆçº§é—®é¢˜ã€‚
