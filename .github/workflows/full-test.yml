name: Full Multi-Dialect Tests

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * 0' # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è¿è¡Œ

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  full-test:
    name: ğŸ§ª Full Multi-Dialect Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: sqlx_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mysql:
        image: mysql:8.3
        env:
          MYSQL_DATABASE: sqlx_test
          MYSQL_ROOT_PASSWORD: root
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: YourStrong@Passw0rd
          ACCEPT_EULA: Y
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q 'SELECT 1' -C"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore

    - name: ğŸ—ï¸ Build
      run: dotnet build --configuration Release --no-restore

    - name: ğŸ“¦ Install SQL Server tools
      run: |
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev

    - name: â³ Wait for databases
      run: sleep 30

    - name: ğŸ—„ï¸ Initialize Databases
      run: |
        PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -c "CREATE DATABASE sqlx_test;"
        PGPASSWORD=postgres psql -h localhost -U postgres -d sqlx_test -f tests/Sqlx.Tests/Infrastructure/init-postgresql.sql
        
        mysql -h 127.0.0.1 -P 3306 -u root -proot -e "CREATE DATABASE sqlx_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
        mysql -h 127.0.0.1 -P 3306 -u root -proot sqlx_test < tests/Sqlx.Tests/Infrastructure/init-mysql.sql
        
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong@Passw0rd' -C -Q "CREATE DATABASE sqlx_test;"
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong@Passw0rd' -C -d sqlx_test -i tests/Sqlx.Tests/Infrastructure/init-sqlserver.sql

    - name: ğŸ§ª Run All Tests (All Dialects)
      timeout-minutes: 45
      env:
        POSTGRESQL_CONNECTION: "Host=localhost;Port=5432;Database=sqlx_test;Username=postgres;Password=postgres"
        MYSQL_CONNECTION: "Server=localhost;Port=3306;Database=sqlx_test;Uid=root;Pwd=root"
        SQLSERVER_CONNECTION: "Server=localhost,1433;Database=sqlx_test;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True"
      run: |
        dotnet test --configuration Release --no-build \
                    --collect:"XPlat Code Coverage" \
                    --logger "console;verbosity=normal" \
                    --logger "trx" \
                    --framework net9.0 \
                    --settings .runsettings.ci \
                    --results-directory ./TestResults

    - name: ğŸ“Š Generate coverage report
      if: always()
      run: |
        dotnet tool install -g dotnet-reportgenerator-globaltool --version 5.2.0 || true
        reportgenerator -reports:"**/TestResults/**/coverage.cobertura.xml" \
                        -targetdir:"coverage-report" \
                        -reporttypes:"Html;Cobertura;JsonSummary"

    - name: ğŸ“¤ Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: full-test-results
        path: |
          **/TestResults/*.trx
          **/TestResults/**/coverage.cobertura.xml
          coverage-report/
        retention-days: 30
