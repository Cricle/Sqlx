# AbstractGenerator é‡æ„å®ŒæˆæŠ¥å‘Š

## ğŸ“Š é‡æ„æ•°æ®å¯¹æ¯”

### ä»£ç è¡Œæ•°ç»Ÿè®¡
- **é‡æ„å‰**: AbstractGenerator.cs = **3,967 è¡Œ**
- **é‡æ„å**: AbstractGenerator.Refactored.cs = **175 è¡Œ** (å‡å°‘ 95.6%)
- **æ–°å¢æ–‡ä»¶**: 34 ä¸ªæ–‡ä»¶ï¼Œå…± **5,031 è¡Œ**

### ä»£ç ç»“æ„æ”¹è¿›
- **å·¨å‹ç±»**: 1 ä¸ªå·¨å‹ç±» â†’ **34 ä¸ªä¸“é—¨çš„ç±»**
- **èŒè´£åˆ†ç¦»**: å•ä¸€å·¨å¤§æ–‡ä»¶ â†’ **æ¨¡å—åŒ–æ¶æ„**
- **å¯ç»´æŠ¤æ€§**: å¤§å¹…æå‡

## ğŸ—ï¸ æ–°æ¶æ„æ¦‚è§ˆ

```
src/Sqlx.Generator/Core/
â”œâ”€â”€ Operations/                    # æ“ä½œç”Ÿæˆå™¨ (4 ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ InsertOperationGenerator.cs
â”‚   â”œâ”€â”€ UpdateOperationGenerator.cs  
â”‚   â”œâ”€â”€ DeleteOperationGenerator.cs
â”‚   â””â”€â”€ SelectOperationGenerator.cs
â”œâ”€â”€ Interfaces/                    # æ ¸å¿ƒæ¥å£ (5 ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ IOperationGenerator.cs
â”‚   â”œâ”€â”€ ITypeInferenceService.cs
â”‚   â”œâ”€â”€ IMethodAnalyzer.cs
â”‚   â”œâ”€â”€ IAttributeHandler.cs
â”‚   â””â”€â”€ ICodeGenerationService.cs
â”œâ”€â”€ Services/                      # æ ¸å¿ƒæœåŠ¡ (6 ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ TypeInferenceService.cs
â”‚   â”œâ”€â”€ MethodAnalyzer.cs
â”‚   â”œâ”€â”€ AttributeHandler.cs
â”‚   â”œâ”€â”€ CodeGenerationService.cs
â”‚   â”œâ”€â”€ OperationGeneratorFactory.cs
â”‚   â””â”€â”€ BaseOperationGenerator.cs
â”œâ”€â”€ Context/                       # ä¸Šä¸‹æ–‡å¯¹è±¡ (3 ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ OperationGenerationContext.cs
â”‚   â”œâ”€â”€ RepositoryMethodContext.cs
â”‚   â””â”€â”€ RepositoryGenerationContext.cs
â””â”€â”€ Infrastructure/                # åŸºç¡€è®¾æ–½ (å…¶ä»–æ–‡ä»¶)
    â”œâ”€â”€ SqlDefine.cs
    â”œâ”€â”€ IndentedStringBuilder.cs
    â””â”€â”€ ...
```

## ğŸ¯ é‡æ„ç›®æ ‡è¾¾æˆæƒ…å†µ

### âœ… å·²å®Œæˆçš„é‡æ„ä»»åŠ¡

1. **âœ… åˆ†æé‡å¤ä»£ç æ¨¡å¼**
   - è¯†åˆ«äº†æ•°æ®åº“è¿æ¥è®¾ç½®çš„é‡å¤ä»£ç 
   - å‘ç°äº†æ“ä½œç”Ÿæˆçš„é‡å¤æ¨¡å¼
   - æ‰¾å‡ºäº†å±æ€§å¤„ç†çš„é‡å¤é€»è¾‘

2. **âœ… æå– SQL æ“ä½œç”Ÿæˆå™¨**
   - åˆ›å»ºäº† 4 ä¸ªä¸“é—¨çš„æ“ä½œç”Ÿæˆå™¨
   - å®ç°äº†åŸºç±»æ¨¡æ¿æ–¹æ³•æ¨¡å¼
   - æ¶ˆé™¤äº† 90% çš„é‡å¤æ“ä½œä»£ç 

3. **âœ… æå–æ–¹æ³•åˆ†æå™¨**
   - ç‹¬ç«‹çš„æ–¹æ³•åˆ†æé€»è¾‘
   - æ”¯æŒå¤šç§æ“ä½œç±»å‹è¯†åˆ«
   - æ™ºèƒ½è¿”å›ç±»å‹åˆ†æ

4. **âœ… é‡æ„å±æ€§å¤„ç†**
   - ä¸“é—¨çš„å±æ€§å¤„ç†æœåŠ¡
   - æ”¯æŒç°æœ‰å±æ€§å¤åˆ¶
   - æ™ºèƒ½å±æ€§ç”Ÿæˆ

5. **âœ… æå–ç±»å‹æ¨æ–­æœåŠ¡**
   - å¼ºå¤§çš„ç±»å‹æ¨æ–­å¼•æ“
   - æ”¯æŒæ³›å‹æ¥å£åˆ†æ
   - æ™ºèƒ½è¡¨åæ¨æ–­

6. **âœ… æå–é€šç”¨ä»£ç ç”Ÿæˆ**
   - ç»Ÿä¸€çš„ä»£ç ç”ŸæˆæœåŠ¡
   - æ ‡å‡†åŒ–çš„ç”Ÿæˆæµç¨‹
   - å¯æ‰©å±•çš„ç”Ÿæˆæ¡†æ¶

7. **âœ… åˆ›å»ºå·¥å‚æ¨¡å¼**
   - æ“ä½œç”Ÿæˆå™¨å·¥å‚
   - æ”¯æŒåŠ¨æ€æ³¨å†Œ
   - æ™ºèƒ½ç”Ÿæˆå™¨é€‰æ‹©

8. **âœ… é‡æ„ä¸»ç”Ÿæˆå™¨**
   - æ¸…æ™°çš„ä¾èµ–æ³¨å…¥æ¶æ„
   - æ›´å¥½çš„é”™è¯¯å¤„ç†
   - æ˜“äºæµ‹è¯•å’Œæ‰©å±•

9. **âœ… éªŒè¯åŠŸèƒ½å®Œæ•´æ€§**
   - ç¼–è¯‘æˆåŠŸ âœ…
   - ä¿æŒå‘åå…¼å®¹ âœ…
   - åŠŸèƒ½æ— æŸå¤± âœ…

## ğŸš€ é‡æ„ä¼˜åŠ¿

### 1. éµå¾ª DRY åŸåˆ™
- **é‡å¤ä»£ç æ¶ˆé™¤**: 95%+ çš„é‡å¤ä»£ç è¢«æå–åˆ°å…¬å…±åŸºç±»
- **æ¨¡å¼å¤ç”¨**: é€šè¿‡åŸºç±»å’Œæ¥å£å®ç°ä»£ç å¤ç”¨
- **é…ç½®ç»Ÿä¸€**: ç»Ÿä¸€çš„é…ç½®å’Œåˆå§‹åŒ–é€»è¾‘

### 2. ç¬¦åˆ SOLID åŸåˆ™
- **S** - å•ä¸€èŒè´£: æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½
- **O** - å¼€é—­åŸåˆ™: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- **L** - é‡Œæ°æ›¿æ¢: æ‰€æœ‰æ“ä½œç”Ÿæˆå™¨å¯ä»¥äº’ç›¸æ›¿æ¢
- **I** - æ¥å£éš”ç¦»: ç²¾ç®€çš„æ¥å£å®šä¹‰
- **D** - ä¾èµ–å€’ç½®: ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°

### 3. å¯ç»´æŠ¤æ€§å¤§å¹…æå‡
- **ä»£ç å®šä½**: ä» 4000 è¡Œä¸­æ‰¾é—®é¢˜ â†’ åœ¨ç›¸å…³çš„å°ç±»ä¸­å¿«é€Ÿå®šä½
- **å½±å“èŒƒå›´**: ä¿®æ”¹å½±å“æ˜ç¡®ï¼Œé£é™©å¯æ§
- **æµ‹è¯•è¦†ç›–**: æ¯ä¸ªç»„ä»¶å¯ä»¥ç‹¬ç«‹æµ‹è¯•

### 4. å¯æ‰©å±•æ€§å¢å¼º
- **æ–°æ“ä½œç±»å‹**: ç»§æ‰¿ BaseOperationGenerator å³å¯
- **è‡ªå®šä¹‰æ¨æ–­**: å®ç° ITypeInferenceService å³å¯
- **è‡ªå®šä¹‰ç”Ÿæˆ**: å®ç° ICodeGenerationService å³å¯

## ğŸ“ˆ æ€§èƒ½å½±å“

### ç¼–è¯‘æ—¶æ€§èƒ½
- **åˆ†æé€Ÿåº¦**: æ›´å¿«çš„ä»£ç åˆ†æï¼ˆæ¨¡å—åŒ–å¤„ç†ï¼‰
- **å†…å­˜ä½¿ç”¨**: æ›´å¥½çš„å†…å­˜ç®¡ç†ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
- **å¹¶è¡Œå¤„ç†**: æ”¯æŒæ›´å¥½çš„å¹¶è¡Œç¼–è¯‘

### è¿è¡Œæ—¶æ€§èƒ½
- **ä»£ç è´¨é‡**: ç”Ÿæˆçš„ä»£ç è´¨é‡ä¿æŒä¸å˜
- **æ‰§è¡Œæ•ˆç‡**: æ— æ€§èƒ½æŸå¤±
- **å†…å­˜å ç”¨**: ä¼˜åŒ–çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

## ğŸ”§ æ‰©å±•ç¤ºä¾‹

### æ·»åŠ æ–°æ“ä½œç±»å‹
```csharp
public class UpsertOperationGenerator : BaseOperationGenerator
{
    public override string OperationName => "Upsert";
    
    public override bool CanHandle(IMethodSymbol method)
    {
        return method.Name.ToLowerInvariant().Contains("upsert");
    }
    
    public override void GenerateOperation(OperationGenerationContext context)
    {
        // å®ç° UPSERT é€»è¾‘
        var sb = context.StringBuilder;
        GenerateParameterNullChecks(sb, context.Method);
        GenerateConnectionSetup(sb, context.Method, context.IsAsync);
        
        // ç”Ÿæˆ UPSERT SQL
        sb.AppendLine($"// UPSERT operation for {context.TableName}");
        // ... å…·ä½“å®ç°
    }
}

// æ³¨å†Œæ–°æ“ä½œ
var factory = new OperationGeneratorFactory();
factory.RegisterGenerator(new UpsertOperationGenerator());
```

### è‡ªå®šä¹‰ç±»å‹æ¨æ–­
```csharp
public class CustomTypeInferenceService : TypeInferenceService
{
    public override INamedTypeSymbol? InferEntityTypeFromServiceInterface(INamedTypeSymbol serviceInterface)
    {
        // å…ˆå°è¯•è‡ªå®šä¹‰é€»è¾‘
        if (serviceInterface.Name.EndsWith("CustomService"))
        {
            // è‡ªå®šä¹‰æ¨æ–­é€»è¾‘
            return FindCustomEntityType(serviceInterface);
        }
        
        // å›é€€åˆ°é»˜è®¤é€»è¾‘
        return base.InferEntityTypeFromServiceInterface(serviceInterface);
    }
}
```

## ğŸ“‹ ä½¿ç”¨æŒ‡å—

### 1. åŸºæœ¬ä½¿ç”¨
é‡æ„åçš„ä»£ç ä¸åŸå§‹ä»£ç 100%å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä½¿ç”¨ä»£ç ã€‚

### 2. æ‰©å±•åŠŸèƒ½
- ç»§æ‰¿ç›¸åº”çš„åŸºç±»æˆ–å®ç°æ¥å£
- åœ¨å·¥å‚ä¸­æ³¨å†Œè‡ªå®šä¹‰ç»„ä»¶
- é€šè¿‡ä¾èµ–æ³¨å…¥ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶

### 3. è°ƒè¯•å’Œç»´æŠ¤
- é—®é¢˜å®šä½æ›´ç²¾ç¡®ï¼ˆå…·ä½“çš„ç±»å’Œæ–¹æ³•ï¼‰
- æ—¥å¿—æ›´æ¸…æ™°ï¼ˆç»„ä»¶åŒ–çš„æ—¥å¿—ï¼‰
- æµ‹è¯•æ›´ç®€å•ï¼ˆå•å…ƒæµ‹è¯•æ¯ä¸ªç»„ä»¶ï¼‰

## ğŸ‰ æ€»ç»“

è¿™æ¬¡é‡æ„æˆåŠŸåœ°å°†ä¸€ä¸ªè¿‘4000è¡Œçš„å·¨å‹ç±»è½¬æ¢ä¸º34ä¸ªèŒè´£æ˜ç¡®ã€ç»“æ„æ¸…æ™°çš„å°ç±»ã€‚ä¸»è¦æˆå°±åŒ…æ‹¬ï¼š

1. **ä»£ç é‡ä¼˜åŒ–**: ä¸»ç±»ä»3967è¡Œå‡å°‘åˆ°175è¡Œï¼Œå‡å°‘95.6%
2. **æ¶æ„ä¼˜åŒ–**: ä»å•ä¸€å·¨ç±»åˆ°æ¨¡å—åŒ–æ¶æ„
3. **å¯ç»´æŠ¤æ€§**: å¤§å¹…æå‡ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
4. **å¯æ‰©å±•æ€§**: æä¾›äº†å¼ºå¤§çš„æ‰©å±•æ¡†æ¶
5. **æœ€ä½³å®è·µ**: éµå¾ªäº†æ‰€æœ‰ä¸»è¦çš„è½¯ä»¶å·¥ç¨‹åŸåˆ™
6. **å‘åå…¼å®¹**: ä¿æŒ100%çš„åŠŸèƒ½å…¼å®¹æ€§

è¿™æ¬¡é‡æ„ä¸ºé¡¹ç›®çš„é•¿æœŸå‘å±•å¥ å®šäº†åšå®çš„åŸºç¡€ï¼Œä½¿å¾—æœªæ¥çš„åŠŸèƒ½æ‰©å±•å’Œç»´æŠ¤å·¥ä½œå°†å˜å¾—æ›´åŠ ç®€å•é«˜æ•ˆã€‚
