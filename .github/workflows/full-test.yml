name: Full Multi-Dialect Tests

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * 0' # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è¿è¡Œ

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  full-test:
    name: ğŸ§ª Full Multi-Dialect Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: sqlx_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5
          --health-start-period 10s
          --shm-size=256mb

      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: sqlx_test
          MYSQL_ROOT_PASSWORD: root
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5
          --health-start-period 15s

      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          SA_PASSWORD: YourStrong@Passw0rd
          ACCEPT_EULA: Y
          MSSQL_PID: Developer
          MSSQL_COLLATION: SQL_Latin1_General_CP1_CI_AS
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q 'SELECT 1' -C -l 1"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
          --health-start-period 20s

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore

    - name: ğŸ—ï¸ Build
      run: dotnet build --configuration Release --no-restore

    - name: ğŸ“¦ Install SQL Server tools
      run: |
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev

    - name: â³ Wait for databases
      run: |
        echo "â³ Databases are starting via health checks..."
        echo "ğŸ” Verifying PostgreSQL..."
        for i in {1..10}; do
          if PGPASSWORD=postgres psql -h localhost -U postgres -c "SELECT 1" > /dev/null 2>&1; then
            echo "âœ… PostgreSQL ready"
            break
          fi
          echo "â³ Waiting for PostgreSQL... ($i/10)"
          sleep 2
        done

        echo "ğŸ” Verifying MySQL..."
        for i in {1..10}; do
          if mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SELECT 1" > /dev/null 2>&1; then
            echo "âœ… MySQL ready"
            break
          fi
          echo "â³ Waiting for MySQL... ($i/10)"
          sleep 2
        done

        echo "ğŸ” Verifying SQL Server..."
        for i in {1..15}; do
          if /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong@Passw0rd' -C -Q "SELECT 1" -l 1 > /dev/null 2>&1; then
            echo "âœ… SQL Server ready"
            break
          fi
          echo "â³ Waiting for SQL Server... ($i/15)"
          sleep 2
        done

        echo "âœ… All databases are ready"

    - name: ğŸ—„ï¸ Initialize Databases
      run: |
        echo "ğŸ—„ï¸ Initializing databases in parallel..."
        
        # PostgreSQL åˆå§‹åŒ–ï¼ˆåå°ï¼‰
        (
          echo "ğŸ—„ï¸ PostgreSQL: Creating database..."
          PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -c "DROP DATABASE IF EXISTS sqlx_test;" 2>/dev/null || true
          PGPASSWORD=postgres psql -h localhost -U postgres -d postgres -c "CREATE DATABASE sqlx_test;"
          echo "ğŸ—„ï¸ PostgreSQL: Running init script..."
          PGPASSWORD=postgres psql -h localhost -U postgres -d sqlx_test -f tests/Sqlx.Tests/Infrastructure/init-postgresql.sql -q
          echo "âœ… PostgreSQL initialized"
        ) &
        PG_PID=$!
        
        # MySQL åˆå§‹åŒ–ï¼ˆåå°ï¼‰
        (
          echo "ğŸ—„ï¸ MySQL: Creating database..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot -e "DROP DATABASE IF EXISTS sqlx_test;" 2>/dev/null || true
          mysql -h 127.0.0.1 -P 3306 -u root -proot -e "CREATE DATABASE sqlx_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
          echo "ğŸ—„ï¸ MySQL: Running init script..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot sqlx_test < tests/Sqlx.Tests/Infrastructure/init-mysql.sql
          echo "âœ… MySQL initialized"
        ) &
        MYSQL_PID=$!
        
        # SQL Server åˆå§‹åŒ–ï¼ˆåå°ï¼‰
        (
          echo "ğŸ—„ï¸ SQL Server: Creating database..."
          /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong@Passw0rd' -C -Q "IF EXISTS (SELECT name FROM sys.databases WHERE name = 'sqlx_test') DROP DATABASE sqlx_test;" -l 5 2>/dev/null || true
          /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong@Passw0rd' -C -Q "CREATE DATABASE sqlx_test;" -l 5
          echo "ğŸ—„ï¸ SQL Server: Running init script..."
          /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong@Passw0rd' -C -d sqlx_test -i tests/Sqlx.Tests/Infrastructure/init-sqlserver.sql -l 5
          echo "âœ… SQL Server initialized"
        ) &
        MSSQL_PID=$!
        
        # ç­‰å¾…æ‰€æœ‰åˆå§‹åŒ–å®Œæˆ
        wait $PG_PID
        wait $MYSQL_PID
        wait $MSSQL_PID
        
        echo "âœ… All databases initialized in parallel"

    - name: ğŸ§ª Run All Tests (All Dialects)
      timeout-minutes: 45
      env:
        POSTGRESQL_CONNECTION: "Host=localhost;Port=5432;Database=sqlx_test;Username=postgres;Password=postgres"
        MYSQL_CONNECTION: "Server=localhost;Port=3306;Database=sqlx_test;Uid=root;Pwd=root"
        SQLSERVER_CONNECTION: "Server=localhost,1433;Database=sqlx_test;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True"
      run: |
        dotnet test --configuration Release --no-build \
                    --collect:"XPlat Code Coverage" \
                    --logger "console;verbosity=normal" \
                    --logger "trx" \
                    --framework net9.0 \
                    --settings .runsettings.ci \
                    --results-directory ./TestResults

    - name: ğŸ“Š Generate coverage report
      if: always()
      run: |
        dotnet tool install -g dotnet-reportgenerator-globaltool --version 5.2.0 || true
        reportgenerator -reports:"**/TestResults/**/coverage.cobertura.xml" \
                        -targetdir:"coverage-report" \
                        -reporttypes:"Html;Cobertura;JsonSummary"

    - name: ğŸ“¤ Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: full-test-results
        path: |
          **/TestResults/*.trx
          **/TestResults/**/coverage.cobertura.xml
          coverage-report/
        retention-days: 30
