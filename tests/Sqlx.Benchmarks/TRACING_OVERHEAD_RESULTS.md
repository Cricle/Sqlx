# Sqlx è¿½è¸ªå¼€é”€æ€§èƒ½æµ‹è¯•ç»“æœ

æµ‹è¯•æ—¥æœŸï¼š2025-10-22  
æµ‹è¯•ç¯å¢ƒï¼šAMD Ryzen 7 5800H, .NET 8.0.21

---

## ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»

### å•è¡ŒæŸ¥è¯¢æ€§èƒ½å¯¹æ¯”

| æ–¹æ³• | å¹³å‡è€—æ—¶ | ç›¸å¯¹åŸºå‡† | ç›¸å¯¹æ¯”ä¾‹ | å†…å­˜åˆ†é… | ç›¸å¯¹åŸºå‡† |
|------|----------|----------|----------|----------|----------|
| **Raw ADO.NET (åŸºå‡†)** | 6.414 Î¼s | 1.00x | - | 904 B | 1.00x |
| **Dapper** | 8.111 Î¼s | 1.26x | æ…¢ 26% | 1,776 B | 1.96x (å¤š96%) |
| **Sqlx é›¶è¿½è¸ª** | 14.675 Î¼s | 2.29x | æ…¢ 129% | 1,240 B | 1.37x (å¤š37%) |
| **Sqlx åªæœ‰æŒ‡æ ‡** | 15.106 Î¼s | 2.36x | æ…¢ 136% | 1,240 B | 1.37x (å¤š37%) |
| **Sqlx å®Œæ•´è¿½è¸ª** | 15.320 Î¼s | 2.39x | æ…¢ 139% | 1,240 B | 1.37x (å¤š37%) |

#### ğŸ” è¿½è¸ªå¼€é”€åˆ†æï¼ˆå•è¡ŒæŸ¥è¯¢ï¼‰

| é…ç½® | è€—æ—¶ | å¼€é”€ | å æ¯” |
|------|------|------|------|
| é›¶è¿½è¸ªï¼ˆåŸºå‡†ï¼‰ | 14.675 Î¼s | 0 Î¼s | 0% |
| + Stopwatch | 15.106 Î¼s | **+0.431 Î¼s** | **+2.9%** |
| + Activity | 15.320 Î¼s | **+0.214 Î¼s** | **+1.4%** |
| **æ€»è¿½è¸ªå¼€é”€** | 15.320 Î¼s | **+0.645 Î¼s** | **+4.4%** |

---

### å¤šè¡ŒæŸ¥è¯¢æ€§èƒ½å¯¹æ¯”ï¼ˆ10æ¡è®°å½•ï¼‰

| æ–¹æ³• | å¹³å‡è€—æ—¶ | ç›¸å¯¹åŸºå‡† | ç›¸å¯¹æ¯”ä¾‹ | å†…å­˜åˆ†é… | ç›¸å¯¹åŸºå‡† |
|------|----------|----------|----------|----------|----------|
| **Raw ADO.NET (åŸºå‡†)** | 16.14 Î¼s | 1.00x | - | 3,264 B | 1.00x |
| **Dapper** | 16.24 Î¼s | 1.01x | æ…¢ 1% | 4,680 B | 1.43x (å¤š43%) |
| **Sqlx é›¶è¿½è¸ª** | 30.19 Î¼s | 1.87x | æ…¢ 87% | 3,952 B | 1.21x (å¤š21%) |
| **Sqlx åªæœ‰æŒ‡æ ‡** | 30.34 Î¼s | 1.88x | æ…¢ 88% | 3,952 B | 1.21x (å¤š21%) |
| **Sqlx å®Œæ•´è¿½è¸ª** | 30.20 Î¼s | 1.87x | æ…¢ 87% | 3,952 B | 1.21x (å¤š21%) |

#### ğŸ” è¿½è¸ªå¼€é”€åˆ†æï¼ˆå¤šè¡ŒæŸ¥è¯¢ï¼‰

| é…ç½® | è€—æ—¶ | å¼€é”€ | å æ¯” |
|------|------|------|------|
| é›¶è¿½è¸ªï¼ˆåŸºå‡†ï¼‰ | 30.19 Î¼s | 0 Î¼s | 0% |
| + Stopwatch | 30.34 Î¼s | **+0.15 Î¼s** | **+0.5%** |
| + Activity | 30.20 Î¼s | **-0.14 Î¼s** | **Â±0%** (è¯¯å·®èŒƒå›´) |
| **æ€»è¿½è¸ªå¼€é”€** | 30.34 Î¼s | **+0.15 Î¼s** | **+0.5%** |

---

## âœ… å…³é”®å‘ç°

### 1. è¿½è¸ªå’ŒæŒ‡æ ‡å¼€é”€æä½ ğŸ‰

**å•è¡ŒæŸ¥è¯¢ï¼š**
- **Stopwatch å¼€é”€**: 0.431 Î¼s (çº¦ **3%**)
- **Activity å¼€é”€**: 0.214 Î¼s (çº¦ **1.4%**)
- **æ€»å¼€é”€**: 0.645 Î¼s (çº¦ **4.4%**)

**å¤šè¡ŒæŸ¥è¯¢ï¼š**
- **Stopwatch å¼€é”€**: 0.15 Î¼s (çº¦ **0.5%**)
- **Activity å¼€é”€**: < 0.15 Î¼s (**å¯å¿½ç•¥**)
- **æ€»å¼€é”€**: 0.15 Î¼s (çº¦ **0.5%**)

**ç»“è®º**ï¼š
- âœ… æ¡ä»¶ç¼–è¯‘è®¾è®¡ **å®Œç¾å·¥ä½œ**
- âœ… `[EnableTracing(false)]` å’Œ `[EnableMetrics(false)]` **çœŸæ­£å®ç°é›¶å¼€é”€**
- âœ… è¿½è¸ªåŠŸèƒ½çš„æ€§èƒ½å½±å“ **å¯ä»¥å¿½ç•¥ä¸è®¡**ï¼ˆ<5%ï¼‰
- âœ… æ•°æ®é‡è¶Šå¤§ï¼Œè¿½è¸ªå¼€é”€å æ¯”è¶Šå°ï¼ˆå¤šè¡ŒæŸ¥è¯¢åªæœ‰0.5%ï¼‰

---

### 2. å†…å­˜æ•ˆç‡ä¼˜äº Dapper âœ…

**å•è¡ŒæŸ¥è¯¢ï¼š**
- Sqlx: 1,240 B
- Dapper: 1,776 B
- **Sqlx æ¯” Dapper å°‘ 30%**

**å¤šè¡ŒæŸ¥è¯¢ï¼ˆ10æ¡ï¼‰ï¼š**
- Sqlx: 3,952 B
- Dapper: 4,680 B
- **Sqlx æ¯” Dapper å°‘ 15.5%**

**ç»“è®º**ï¼š
- âœ… Sqlx å†…å­˜æ•ˆç‡ä¼˜äº Dapper
- âœ… è¿½è¸ªåŠŸèƒ½ **ä¸å¢åŠ ** å†…å­˜åˆ†é…ï¼ˆé›¶è¿½è¸ªã€åªæœ‰æŒ‡æ ‡ã€å®Œæ•´è¿½è¸ªå†…å­˜å®Œå…¨ç›¸åŒï¼‰

---

### 3. Sqlx æ ¸å¿ƒæ€§èƒ½éœ€è¦ä¼˜åŒ– âš ï¸

**å•è¡ŒæŸ¥è¯¢ï¼š**
- Sqlx é›¶è¿½è¸ª: 14.675 Î¼s
- Dapper: 8.111 Î¼s
- **Sqlx æ¯” Dapper æ…¢ 81%**

**å¤šè¡ŒæŸ¥è¯¢ï¼š**
- Sqlx é›¶è¿½è¸ª: 30.19 Î¼s
- Dapper: 16.24 Î¼s
- **Sqlx æ¯” Dapper æ…¢ 86%**

**è¿™æ˜¯æ ¸å¿ƒæ€§èƒ½é—®é¢˜ï¼Œä¸è¿½è¸ªæ— å…³ï¼**

**å¯èƒ½çš„ä¼˜åŒ–æ–¹å‘ï¼š**
1. âœ… å·²ä¼˜åŒ–ï¼šç›´æ¥åºå·è®¿é—® (GetInt32(0) è€Œä¸æ˜¯ GetOrdinal)
2. â“ å¾…æ£€æŸ¥ï¼šå‚æ•°åŒ–æŸ¥è¯¢çš„æ€§èƒ½
3. â“ å¾…æ£€æŸ¥ï¼šå¯¹è±¡åˆ›å»ºå’Œåˆå§‹åŒ–
4. â“ å¾…æ£€æŸ¥ï¼šè¿æ¥çŠ¶æ€æ£€æŸ¥çš„å¼€é”€
5. â“ å¾…æ£€æŸ¥ï¼šç”Ÿæˆä»£ç çš„ILè´¨é‡

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”å›¾è¡¨

### å•è¡ŒæŸ¥è¯¢æ€§èƒ½æ¢¯åº¦

```
Raw ADO.NET (åŸºå‡†)    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 6.4 Î¼s  
Dapper               â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 8.1 Î¼s (+26%)
Sqlx é›¶è¿½è¸ª           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 14.7 Î¼s (+129%)
Sqlx åªæœ‰æŒ‡æ ‡          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 15.1 Î¼s (+136%)
Sqlx å®Œæ•´è¿½è¸ª          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 15.3 Î¼s (+139%)
```

### å¤šè¡ŒæŸ¥è¯¢æ€§èƒ½æ¢¯åº¦

```
Raw ADO.NET (åŸºå‡†)    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 16.1 Î¼s  
Dapper               â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 16.2 Î¼s (+1%)
Sqlx é›¶è¿½è¸ª           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 30.2 Î¼s (+87%)
Sqlx åªæœ‰æŒ‡æ ‡          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 30.3 Î¼s (+88%)
Sqlx å®Œæ•´è¿½è¸ª          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 30.2 Î¼s (+87%)
```

### è¿½è¸ªå¼€é”€å æ¯”

**å•è¡ŒæŸ¥è¯¢ï¼š**
```
æ ¸å¿ƒæ€§èƒ½å¼€é”€ (vs Dapper)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 6.6 Î¼s (93%)
è¿½è¸ªå¼€é”€                  â–ˆâ–ˆ 0.6 Î¼s (7%)
```

**å¤šè¡ŒæŸ¥è¯¢ï¼š**
```
æ ¸å¿ƒæ€§èƒ½å¼€é”€ (vs Dapper)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 14.0 Î¼s (99%)
è¿½è¸ªå¼€é”€                  â–ˆ 0.2 Î¼s (1%)
```

**ç»“è®º**ï¼š
- è¿½è¸ªå¼€é”€åªå æ€»æ€§èƒ½å·®è·çš„ **1-7%**
- **æ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–** æ‰æ˜¯å…³é”®ï¼Œè€Œä¸æ˜¯è¿½è¸ª

---

## ğŸ¯ ç»“è®ºå’Œå»ºè®®

### âœ… æˆåŠŸä¹‹å¤„

1. **è¿½è¸ªç‰¹æ€§è®¾è®¡æˆåŠŸ**
   - `[EnableTracing]` å’Œ `[EnableMetrics]` ç‰¹æ€§å·¥ä½œå®Œç¾
   - æ¡ä»¶ç¼–è¯‘çœŸæ­£å®ç°é›¶å¼€é”€
   - ç¦ç”¨è¿½è¸ªæ—¶ï¼Œç”Ÿæˆçš„ä»£ç ä¸åŒ…å«ä»»ä½•è¿½è¸ªé€»è¾‘

2. **å†…å­˜æ•ˆç‡ä¼˜ç§€**
   - æ¯” Dapper å°‘åˆ†é… 15-30% å†…å­˜
   - è¿½è¸ªåŠŸèƒ½ä¸å¢åŠ å†…å­˜å¼€é”€

3. **å¯è§‚æµ‹æ€§å®Œæ•´**
   - æ”¯æŒ .NET Activity æ ‡å‡†
   - æ”¯æŒ Stopwatch ç²¾ç¡®è®¡æ—¶
   - æ”¯æŒ Partial æ–¹æ³•è‡ªå®šä¹‰æ‹¦æˆª

### âš ï¸ éœ€è¦æ”¹è¿›

1. **æ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–**
   - Sqlx é›¶è¿½è¸ªç‰ˆæœ¬ä»æ¯” Dapper æ…¢ 80-90%
   - è¿™æ˜¯ **ä¸»è¦é—®é¢˜**ï¼Œä¸è¿½è¸ªæ— å…³
   - éœ€è¦æ·±å…¥åˆ†æç”Ÿæˆä»£ç å’Œæ‰§è¡Œè·¯å¾„

2. **æ€§èƒ½ä¼˜åŒ–ä¼˜å…ˆçº§**
   ```
   1. æ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–ï¼ˆé¢„æœŸæå‡ï¼š50-80%ï¼‰
   2. å‚æ•°åŒ–æŸ¥è¯¢ä¼˜åŒ–ï¼ˆé¢„æœŸæå‡ï¼š10-20%ï¼‰
   3. å¯¹è±¡åˆå§‹åŒ–ä¼˜åŒ–ï¼ˆé¢„æœŸæå‡ï¼š5-10%ï¼‰
   4. è¿½è¸ªä»£ç ä¼˜åŒ–ï¼ˆé¢„æœŸæå‡ï¼š<5%ï¼‰â† ä¼˜å…ˆçº§æœ€ä½
   ```

### ğŸ’¡ ä½¿ç”¨å»ºè®®

**æ ¹æ®åœºæ™¯é€‰æ‹©é…ç½®ï¼š**

1. **æè‡´æ€§èƒ½åœºæ™¯**ï¼ˆé«˜é¢‘æŸ¥è¯¢ï¼ŒQPS > 1000ï¼‰
   ```csharp
   [EnableTracing(false)]
   [EnableMetrics(false)]
   ```

2. **ç”Ÿäº§ç¯å¢ƒ - APMé›†æˆ**
   ```csharp
   [EnableTracing(true, LogSql = false)]  // Activityè¿½è¸ªä½†ä¸è®°å½•SQL
   [EnableMetrics(false)]
   ```

3. **ç”Ÿäº§ç¯å¢ƒ - æ…¢æŸ¥è¯¢ç›‘æ§**
   ```csharp
   [EnableTracing(false)]
   [EnableMetrics(true)]  // åªè¦æ‰§è¡Œæ—¶é—´ï¼Œä¸è¦Activity
   ```

4. **å¼€å‘å’Œè°ƒè¯•**
   ```csharp
   [EnableTracing(true, LogSql = true, LogParameters = true)]
   [EnableMetrics(true)]
   ```

**æ–¹æ³•çº§åˆ«ä¼˜åŒ–ç¤ºä¾‹ï¼š**

```csharp
[RepositoryFor(typeof(IUserRepository))]
public partial class UserRepository : IUserRepository
{
    // é«˜é¢‘æŸ¥è¯¢ï¼šç¦ç”¨æ‰€æœ‰è¿½è¸ª
    [EnableTracing(false)]
    [EnableMetrics(false)]
    [Sqlx("SELECT {{columns}} FROM {{table}} WHERE id = @id")]
    User? GetByIdSync(int id);  // æ¯ç§’1000+æ¬¡è°ƒç”¨

    // ä½é¢‘ä½†é‡è¦ï¼šå¯ç”¨å®Œæ•´è¿½è¸ª
    [EnableTracing(true)]
    [EnableMetrics(true)]
    [Sqlx("INSERT INTO {{table}} ...")]
    int InsertSync(...);  // æ¯ç§’<10æ¬¡è°ƒç”¨
}
```

---

## ğŸ“‹ æµ‹è¯•è¯¦æƒ…

**æµ‹è¯•ç¯å¢ƒï¼š**
- CPU: AMD Ryzen 7 5800H
- è¿è¡Œæ—¶: .NET 8.0.21 (X64 RyuJIT AVX2)
- GC: Concurrent Server
- ç¼–è¯‘æ¨¡å¼: Release
- æ•°æ®åº“: SQLite (å†…å­˜æ¨¡å¼)

**æµ‹è¯•æ–¹æ³•ï¼š**
- ä½¿ç”¨ BenchmarkDotNet 0.14.0
- é¢„çƒ­ï¼š6-10 æ¬¡è¿­ä»£
- å®é™…æµ‹è¯•ï¼š13-15 æ¬¡è¿­ä»£
- ç½®ä¿¡åŒºé—´ï¼š99.9%
- å†…å­˜è¯Šæ–­ï¼šå·²å¯ç”¨

**æµ‹è¯•æ•°æ®ï¼š**
- å•è¡ŒæŸ¥è¯¢ï¼š1 æ¡è®°å½•
- å¤šè¡ŒæŸ¥è¯¢ï¼š10 æ¡è®°å½•
- æ•°æ®åº“é¢„å¡«å……ï¼š100 æ¡æµ‹è¯•æ•°æ®
- æ¯æ¡è®°å½•ï¼š8 ä¸ªå­—æ®µï¼ˆint, string, decimal, bool, DateTimeï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [è¿½è¸ªå’ŒæŒ‡æ ‡ç‰¹æ€§æ§åˆ¶](../../docs/TRACING_AND_METRICS_ATTRIBUTES.md)
- [è¿½è¸ªå¼€é”€æµ‹è¯•æŒ‡å—](./TRACING_OVERHEAD_BENCHMARKS.md)
- [Partial æ–¹æ³•æŒ‡å—](../../docs/PARTIAL_METHODS_GUIDE.md)
- [æ€§èƒ½ä¼˜åŒ–è®¡åˆ’](../../PERFORMANCE_ANALYSIS.md)

---

## ğŸ“Œ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. **æ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–**
   - [ ] åˆ†æç”Ÿæˆçš„ILä»£ç 
   - [ ] å¯¹æ¯” Dapper çš„ILä»£ç 
   - [ ] ä¼˜åŒ–å¯¹è±¡åˆ›å»ºè·¯å¾„
   - [ ] ä¼˜åŒ–å‚æ•°ç»‘å®š

2. **æ€§èƒ½æµ‹è¯•**
   - [x] å•è¡ŒæŸ¥è¯¢è¿½è¸ªå¼€é”€æµ‹è¯•
   - [x] å¤šè¡ŒæŸ¥è¯¢è¿½è¸ªå¼€é”€æµ‹è¯•
   - [ ] å¤æ‚æŸ¥è¯¢è¿½è¸ªå¼€é”€æµ‹è¯•
   - [ ] CRUDæ“ä½œè¿½è¸ªå¼€é”€æµ‹è¯•

### åç»­ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

3. **è¿½è¸ªåŠŸèƒ½ä¼˜åŒ–**ï¼ˆé¢„æœŸæå‡ <5%ï¼‰
   - [ ] Activity åˆ›å»ºä¼˜åŒ–
   - [ ] Stopwatch ä½¿ç”¨ä¼˜åŒ–
   - [ ] Partial æ–¹æ³•è°ƒç”¨ä¼˜åŒ–

4. **æ–‡æ¡£æ›´æ–°**
   - [x] æ€§èƒ½æµ‹è¯•ç»“æœæ–‡æ¡£
   - [ ] æœ€ä½³å®è·µæŒ‡å—
   - [ ] FAQ å’Œæ•…éšœæ’æŸ¥

---

**æµ‹è¯•å®Œæˆæ—¶é—´**: 2025-10-22 14:45  
**æŠ¥å‘Šç”Ÿæˆ**: è‡ªåŠ¨ç”Ÿæˆ  
**æ•°æ®æ¥æº**: BenchmarkDotNet å®é™…æµ‹è¯•ç»“æœ

